<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=0.8, user-scalable=yes">
  <title>Best Turizo Insurance Platform</title>
  <link rel="icon" type="image/png"
    href="https://raw.githubusercontent.com/Domichico20/Best-Turizo-Insurace-Software/e71261e9aa44cbf53c48da6199c9847aea40a302/logo.png">
  <link rel="apple-touch-icon"
    href="https://raw.githubusercontent.com/Domichico20/Best-Turizo-Insurace-Software/e71261e9aa44cbf53c48da6199c9847aea40a302/logo.png">
  <link rel="preconnect" href="https://sheets.googleapis.com" crossorigin>
  <link rel="dns-prefetch" href="https://sheets.googleapis.com">
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="dns-prefetch" href="https://script.google.com">

  <style>
    /* Show logo only on Login + Main (list) pages */
    body.is-customer header {
      display: none;
    }




    /* Pause the rainbow animation once we leave the list page */
    body.is-customer .search-btn {
      animation: none !important;
    }


    /* ===== Base / Theme ===== */
    :root {
      --bg: #f6f7f9;
      --card: #ffffff;
      --ink: #3b2f22;
      --muted: #6b7280;
      --border: #e5e7eb;
      --brand1: #c59b6a;
      --brand2: #ab7d4a;
      --ok: #16a34a;
      --warn: #f59e0b;
      --danger: #ef4444;
      --radius: 14px;
      --shadow: 0 8px 24px rgba(16, 24, 40, .06);
      --pdf-icon-size: 40px;
    }

    .attc-icon {
      display: inline-flex;
      width: var(--pdf-icon-size);
      height: var(--pdf-icon-size);
      align-items: center;
      justify-content: center;
    }

    .attc-icon svg {
      width: 100%;
      height: 100%;
    }

    html,
    body {
      background: var(--bg);
      color: var(--ink);
      font: 14px/1.55 system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      margin: 0;
      /* <-- remove default 8px gap around the page */
      padding: 0;
    }


    header {
      text-align: center;
      margin: 0;
      /* no external gap */
      padding: 0;
      /* no internal gap */
      line-height: 0;
      /* collapses any inline line box */
    }



    header img.logo {
      display: block;
      margin: 0 auto -40px;
      /* <-- pull the next section up; adjust -20..-40 if needed */
      max-width: 540px;
      height: auto;
      filter: drop-shadow(0 8px 18px rgba(0, 0, 0, .08));
      pointer-events: none;
      /* <-- allow clicks on the search input below */
    }


    /* Ensure nothing re-introduces top spacing under the header */
    #loginSection,
    #appSection {
      margin-top: 0 !important;
    }




    /* ===== Login (UNCHANGED) ===== */
    #loginSection {
      width: 100%;
      max-width: 400px;
      padding: 28px;
      gap: 12px;
      margin: 0 auto;
      border-radius: 20px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
    }

    #loginSection input {
      padding: 20px 100px;
      font-size: 16px;
      text-align: center;
      border: 1px solid var(--border);
      border-radius: 12px;
      outline: none;
      transition: border .15s;
    }

    #loginSection input::placeholder {
      text-align: center;
    }

    #loginSection input:focus {
      border-color: var(--brand1);
      box-shadow: 0 0 0 3px rgba(197, 155, 106, .18);
    }

    #loginSection button {
      width: 70%;
      margin: 0 auto;
      padding: 12px 14px;
      font-size: 20px;
      border-radius: 10px;
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      color: #fff;
      border: 0;
      cursor: pointer;
    }

    #customerPage .wrap {
      width: min(1400px, 96vw);
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(16, 24, 40, .08);
      padding: 22px 24px;
      box-sizing: border-box;
    }


    /* ===== Search Bar ===== */
    #searchSection {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin: 0 auto 12px;
      width: min(1250px, 96vw);
    }



    #searchSection input[type="text"] {
      flex: 0 1 920px;
      max-width: 920px;
      width: 100%;
      padding: 12px 14px;
      font-size: 1.75rem;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
    }


    #searchSection input[type="text"]:focus {
      border-color: var(--brand1);
      box-shadow: 0 0 0 3px rgba(197, 155, 106, .15);
    }

    .search-btn {
            font-size: 1rem;
            font-weight: 700;
            padding: 25px 40px;
            border-radius: 18px;
            color: #fff;
            border: 0;
            cursor: pointer;
            letter-spacing: 1px;
            text-transform: uppercase;
            position: relative;
            overflow: hidden;
            z-index: 1;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            background: linear-gradient(90deg, 
                #FF0000, #FF2400, #FF4900, #FF6D00, #FF9200,
                #FFB600, #FFDB00, #FFFF00, #E6FF00, #CCFF00,
                #B3FF00, #99FF00, #80FF00, #66FF00, #4DFF00,
                #33FF00, #1AFF00, #00FF00, #00FF1A, #00FF33,
                #00FF4D, #00FF66, #00FF80, #00FF99, #00FFB3,
                #00FFCC, #00FFE6, #00FFFF, #00E6FF, #00CCFF,
                #00B3FF, #0099FF, #0080FF, #0066FF, #004DFF,
                #0033FF, #001AFF, #0000FF, #1A00FF, #3300FF,
                #4D00FF, #6600FF, #8000FF, #9900FF, #B300FF,
                #CC00FF, #E600FF, #FF00FF, #FF00E6, #FF00CC,
                #FF00B3, #FF0099, #FF0080, #FF0066, #FF004D,
                #FF0033, #FF001A, #FF0000);
            background-size: 1200% 100%;
            animation: gradientShift 16s infinite linear, pulseGlow 4s infinite alternate;
            box-shadow: 
                0 0 20px rgba(255, 100, 255, 0.7),
                0 0 40px rgba(100, 200, 255, 0.5),
                0 0 60px rgba(255, 255, 100, 0.3),
                0 10px 30px rgba(0, 0, 0, 0.4);
        }


    .search-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(156, 66, 25, .6);
      animation-duration: 3s;
    }


    @keyframes gradientShift {
      0% {
        background-position: 0% 50%
      }

      100% {
        background-position: 200% 50%
      }
    }


    /* ===== Data Table ===== */
    #dataTable {
      width: 100%;
      margin: 0 auto;
      border-collapse: separate;
      border-spacing: 0;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(16, 24, 40, .06);
      table-layout: fixed;
    }

    #dataTable thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      /* Refined gold ribbon using same colors */
      background: linear-gradient(180deg,
          #d1a66e 0%,
          #b1874f 20%,
          #b3803d 45%,
          #a06e2c 60%,
          #b3803d 75%,
          #b1874f 88%,
          #d1a66e 100%);
      color: #f3f4f7;
      text-transform: uppercase;
      letter-spacing: .10em;
      font-weight: 800;
      font-size: 1.45rem;
      padding: 14px 16px;
      text-align: center;
      border-bottom: 1px solid rgba(0, 0, 0, .08);
      box-shadow:
        inset 0 1px 0 rgba(255, 255, 255, .25),
        inset 0 -1px 0 rgba(0, 0, 0, .08);
    }

    /* Subtle column separators & rounded top corners */
    #dataTable thead th+th {
      box-shadow:
        inset 1px 0 0 rgba(255, 255, 255, .18),
        inset 0 -1px 0 rgba(0, 0, 0, .08);
    }

    #dataTable thead th:first-child {
      border-top-left-radius: 14px;
    }

    #dataTable thead th:last-child {
      border-top-right-radius: 14px;
    }

    #dataTable tbody td,
    #dataTable tbody th {
      padding: 12px 14px;
      border-top: 1px solid #eef2f7;
      vertical-align: middle;
      color: #0f172a;
      font-size: 20px;
      line-height: 1.35;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }


/* Hide specific inputs in the Customer Info form */
#tab-info #custInfoForm .fg:has(#ci_policy),
#tab-info #custInfoForm .fg:has(#ci_insurer),
#tab-info #custInfoForm .fg:has(#ci_effDate),
#tab-info #custInfoForm .fg:has(#ci_expDate),
#tab-info #custInfoForm .fg:has(#ci_year),
#tab-info #custInfoForm .fg:has(#ci_make),
#tab-info #custInfoForm .fg:has(#ci_model),
#tab-info #custInfoForm .fg:has(#ci_vin) {
  display: none;
}

/* Hide the first 4 summary cards ONLY on the Customer Info tab */
#customerPage.info-active #custDetailsGrid .card:nth-child(-n+4) {
  display: none;
}



    #dataTable tbody tr:nth-child(odd) {
      background: #fcfcff;
    }

    #dataTable tbody tr:hover {
      background: #f5f8ff;
    }

    #dataTable tr.selected {
      background: #e8f0ff !important;
      box-shadow: inset 0 0 0 2px rgba(59, 130, 246, .35);
    }

    /* Selected/highlighted row in Policies table */
    .themed-table tr.selected {
      background: #e8f0ff !important;
      box-shadow: inset 0 0 0 2px rgba(59, 130, 246, .35);
    }


    /* Status pill + Go button */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 1.35rem;
    }

    .badge.active {
      border: 1px solid #113f18;
      background: #66b684;
      color: #1e1ca3;
      cursor: default;
    }

    .badge.inactive {
      background: #fdecec;
      color: #991b1b;
      border: 1px solid #fecaca;
      cursor: default
    }

    .go-btn {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #113f18;
      background: #66b684;
      color: #1e1ca3;
      cursor: pointer;
      font-weight: 1000;
    }

    .go-btn:hover {
      background: #fa5656;
    }

    #customerPage .topbar {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 12px;
    }


    #customerPage .title {
      font-size: 2.15rem;
      font-weight: 900;
      letter-spacing: .3px;
      background: linear-gradient(90deg, #7c5b2e, #c79d4b 60%, #7c5b2e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 1px 0 rgba(0, 0, 0, .04);
    }


    /* Tabs row */
    .tabs {
      display: flex;
      gap: 12px;
      margin: 12px 0 16px;
      flex-wrap: wrap;
    }


    /* Modern pill tabs */

    .tab {
      appearance: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;

      /* bigger + consistent size */
      padding: 12px 20px;
      min-height: 44px;
      width: 140px;
      /* <- all 8 will match this width */
      border-radius: 999px;

      border: 1px solid #8a673c;
      background: linear-gradient(180deg,
          #d1a66e 0%,
          #b1874f 35%,
          #9c6a33 70%,
          #7c5b2e 100%);
      color: #ffffff;
      font-weight: 800;
      font-size: 1.20rem;
      line-height: 1;

      box-shadow: inset 0 1px 0 rgba(255, 255, 255, .25), 0 8px 14px rgba(16, 24, 40, .10);
      transition:
        background .2s ease,
        transform .12s ease,
        box-shadow .2s ease,
        color .2s ease,
        border-color .2s ease;
    }



    /* Hover / Press / Focus */
    .tab:hover {
      transform: translateY(-1px);
      background: linear-gradient(180deg,
          #e0be8a 0%,
          #c39a62 38%,
          #a5743c 70%,
          #835829 100%);
      box-shadow: 0 12px 22px rgba(16, 24, 40, .16);
    }


    .tab:active {
      transform: none;
      box-shadow: inset 0 4px 10px rgba(0, 0, 0, .18);
      background: linear-gradient(180deg, #8a5f2d 0%, #70461b 100%);
    }


    .tab:focus-visible {
      outline: none;
      box-shadow: 0 0 0 3px rgba(197, 155, 106, .35);
    }

    /* Selected tab (brand gradient) */
    .tab[aria-selected="true"] {
      background: linear-gradient(180deg, #b14a4a 0%, #7d2a2a 50%, #522222 100%);
      color: #ffffff;
      border-color: #5a3b1a;
      box-shadow: 0 8px 18px rgba(123, 88, 46, .45);
    }




    .tabpanel {
      display: none;
    }

    .tabpanel.active {
      display: block;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 18px;
      /* NEW: make this whole block look like a distinct panel */
      padding: 16px;
      margin-bottom: 14px;
      border: 1px solid #e7d4bd;
      border-radius: 16px;
      background: radial-gradient(140% 140% at 0% 0%, #ffffff 0%, #f9f4ea 100%);
      box-shadow: 0 10px 30px rgba(16, 24, 40, .06);
    }



    @media(max-width:1100px) {
      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .card {
      background: linear-gradient(180deg, #ffffff 0%, #fbf7f0 100%);
      border: 1px solid #eadcc6;
      border-radius: 14px;
      padding: 12px 14px;
      box-shadow: 0 3px 10px rgba(16, 24, 40, .05);
    }


    .label {
      font-size: 1.5rem;
      color: #6f5a3e;
      margin-bottom: 4px;
      text-transform: uppercase;
      letter-spacing: .06em;
    }



    .value {
      font-weight: 600;
      font-size: 1.20rem;
      color: #3b2f22;
      /* ties to --ink feel */
      letter-spacing: .01em;
      line-height: 1.25;
      word-break: break-word;
    }




    /* Forms */
    .form {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 12px 14px;
    }

    .form .fg {
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    #custInfoForm .fg label,
    #policyEditor .fg label {
      font-size: 1.5rem;
      color: #6f5a3e;
      letter-spacing: .06em;
      text-transform: uppercase;
      font-weight: 700;
      margin: 0 0 4px;
      /* match the top cards */
    }


    .form .fg input,
    .form .fg textarea,
    .form .fg select {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 14px;
      background: #fff;
      box-shadow: 0 1px 0 rgba(16, 24, 40, .02) inset;
      transition: border-color .15s, box-shadow .15s;
      font-size: 1.20rem;
      line-height: 1.25;
    }



    .form .fg input:focus,
    .form .fg textarea:focus {
      border-color: var(--brand1);
      box-shadow: 0 0 0 3px rgba(197, 155, 106, .18);
      outline: none;
    }


    .row-full {
      grid-column: 1/-1;
    }

    .row-6 {
      grid-column: span 6;
    }

    .row-4 {
      grid-column: span 4;
    }

    .row-3 {
      grid-column: span 3;
    }

    .row-2 {
      grid-column: span 2;
    }

    /* NEW: distinct, clean panel for the editable form */
    #custInfoForm {
      background: #ffffff;
      border: 1px solid #ece5d6;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 6px 18px rgba(16, 24, 40, .04);
    }


    .actionbar {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }

    .btn {
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #fff;
      cursor: pointer;
      font-weight: 800;
      box-shadow: 0 4px 12px rgba(16, 24, 40, .06);
      transition: transform .08s ease, box-shadow .12s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(16, 24, 40, .10);
    }

    .btn.primary {
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      color: #fff;
      border: 0;

      /* match top tab size */
      width: 140px;
      min-height: 44px;
      padding: 12px 20px;
      border-radius: 999px;
      font-size: 1.20rem;
      line-height: 1;
    }



    /* Make date inputs in the policy editor ~2√ó larger */
    /* Make date inputs in the policy editor ~1√ó (half of previous) */
    #policyEditor input[type="date"] {
      font-size: 0.8rem;
      padding: 8px 7px;
      height: 29px;
    }

    #policyEditor input[type="date"]::-webkit-calendar-picker-indicator {
      transform: scale(0.9);
    }

    #policyEditor input::-webkit-datetime-edit {
      font-size: 0.7rem;
    }

    /* Bigger popup calendar (Flatpickr) */
    .flatpickr-calendar {
      transform: scale(1.8);
      transform-origin: top left;
      z-index: 99999;
    }

    .flatpickr-day {
      width: 4.1rem;
      height: 4.1rem;
      line-height: 2.1rem;
      font-size: 1.1rem;
    }

    /* Tables inside customer page */


    /* Tables inside customer page */
    .themed-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(16, 24, 40, .06);
      table-layout: fixed;
    }


    .themed-table td,
    .themed-table th {
      text-align: center;
      font-size: 1.35rem;

    }


    .themed-table thead th {
      position: sticky;
      top: 0;
      z-index: 2;
      background: linear-gradient(180deg,
          #d1a66e 0%,
          #b1874f 20%,
          #b3803d 45%,
          #a06e2c 60%,
          #b3803d 75%,
          #b1874f 88%,
          #d1a66e 100%);
      color: #fefefe;
      text-transform: uppercase;
      letter-spacing: .10em;
      font-weight: 800;
      font-size: 1.25rem;
      padding: 12px 14px;
      text-align: center;
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, .22),
        inset 0 -1px 0 rgba(0, 0, 0, .10);
    }


    .themed-table thead th+th {
      box-shadow: inset 1px 0 0 rgba(255, 255, 255, .18),
        inset 0 -1px 0 rgba(0, 0, 0, .08);
    }

    .themed-table thead th:first-child {
      border-top-left-radius: 14px;
    }

    .themed-table thead th:last-child {
      border-top-right-radius: 14px;
    }


    .themed-table td {
      padding: 9px 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-top: 1px solid #eef2f7;
    }

    /* Notes Tab */
    /* Notes Tab */
    /* Notes Tab */
    .notes-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 420px;
      overflow-y: auto;
      padding-right: 8px;
    }

    /* üî¥ CRITICAL ALERT - Dynamic & Attention-Grabbing */
    .note-entry.critical {
      background: linear-gradient(145deg, #d93025, #b0251d, #8a1812, #7c120c);
      /* Subtle gradient for depth */
      color: #fff;
      font-size: 1.5em;
      font-weight: 900;
      /* Even bolder weight (900 is the strongest) */
      border-radius: 10px;
      padding: 10px 16px;
      /* Slightly more padding for better presence */
      display: inline-block;
      border: 2px solid #ff4d4d;
      /* Bright border to make it "pop" */
      box-shadow: 0 4px 8px rgba(217, 48, 37, 0.4);
      /* Soft shadow for depth */
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      /* Improves text readability on background */
      transition: all 0.3s ease;
      /* Smooth transition for hover effects */
    }

    /* Optional: Add a hover effect to make it interactive */
    .note-entry.critical:hover {
      transform: translateY(-2px);
      /* Slight "lift" effect */
      box-shadow: 0 6px 12px rgba(217, 48, 37, 0.5);
      /* Enhanced shadow on hover */
      cursor: pointer;
    }


    .note-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 6px 14px rgba(16, 24, 40, .05);
    }

    .note-meta {
      font-size: 1.25rem;
      color: #465a83;
      margin-bottom: 6px;
    }


    .note-text {
      white-space: pre-wrap;
      overflow-wrap: anywhere;
      font-size: 1.55rem;
      line-height: 1.6;
    }


    /* === Modern upload control === */
    .hid-input {
      display: none;
    }

    .attc-upload {
      margin: 10px 0 16px;
    }

    .attc-dropzone {
      display: grid;
      grid-template-columns: 36px 1fr auto;
      align-items: center;
      gap: 12px;

      padding: 14px 16px;
      border-radius: 16px;
      border: 2px dashed #d7c3a6;
      background: linear-gradient(180deg, #ffffff 0%, #fbf7f0 100%);

      color: var(--ink);
      cursor: pointer;
      box-shadow: 0 6px 18px rgba(16, 24, 40, .06);
      transition: border-color .2s, box-shadow .2s, transform .1s, background .2s;
    }

    .attc-dropzone:hover {
      transform: translateY(-1px);
      border-color: var(--brand1);
      box-shadow: 0 10px 24px rgba(16, 24, 40, .10);
    }

    .attc-dropzone.dragover {
      border-color: var(--brand2);
      background: radial-gradient(120% 140% at 0% 0%, #fff 0%, #fffbed 100%);
    }

    .attc-dropzone svg {
      width: 28px;
      height: 28px;
      color: var(--brand2);
    }

    .attc-dropzone .text strong {
      display: block;
      font-size: 1.1rem;
      line-height: 1.1;
    }

    .attc-dropzone .text span {
      display: block;
      font-size: .95rem;
      color: var(--muted);
      margin-top: 2px;
    }

    .attc-dropzone .meta {
      font-size: .9rem;
      color: #6b7280;
      white-space: nowrap;
    }

    .attc-file {
      margin-top: 8px;
      font-size: .95rem;
      color: #334155;
    }

    .attc-file .name {
      font-weight: 700;
    }

    /* ---- Floating uploader (bottom-right outside the white card) ---- */
    #tab-files .attc-upload,
    #tab-accord .attc-upload {
      position: fixed;
      /* pull it out of the flow/card */
      right: 175px;
      /* sit in the page margin at lower-right */
      bottom: 465px;
      width: 300px;
      /* fits the red box in your screenshot */
      margin: 0;
      z-index: 3000;
      /* above the card / tables */
      pointer-events: auto;
    }

    /* Compact the dropzone so it reads well in a 300px panel */
    #tab-files .attc-dropzone,
    #tab-accord .attc-dropzone {
      grid-template-columns: 24px 1fr;
      /* smaller icon column */
      gap: 10px;
      padding: 12px 14px;
      border-radius: 12px;
    }

    #tab-files .attc-dropzone svg,
    #tab-accord .attc-dropzone svg {
      width: 24px;
      height: 24px;
    }

    #tab-files .attc-dropzone .text strong,
    #tab-accord .attc-dropzone .text strong {
      font-size: 1rem;
    }

    #tab-files .attc-dropzone .text span,
    #tab-accord .attc-dropzone .text span {
      font-size: .9rem;
    }

    #tab-files .attc-dropzone .meta,
    #tab-accord .attc-dropzone .meta {
      font-size: .8rem;
    }

    /* The little "Selected: filename" line stays with the floating box */
    #tab-files .attc-file,
    #tab-accord .attc-file {
      margin-top: 8px;
      font-size: 1.1rem;
    }

    /* Optional: on very small screens, tuck it tighter */
    @media (max-width: 1200px) {

      #tab-files .attc-upload,
      #tab-accord .attc-upload {
        right: 12px;
        bottom: 12px;
        width: 260px;
      }
    }

    /* quick spinner for optimistic rows */
    .attc-spin {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid #d7c3a6;
      border-top-color: #ab7d4a;
      border-radius: 50%;
      animation: attcspin .6s linear infinite;
      vertical-align: middle;
      margin-right: 6px;
    }

    @keyframes attcspin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Notes input size (fixed, non-resizable) */
    #noteInput {
      width: 100%;
      max-width: 1310px;

      height: 80px;
      min-height: 80px;
      max-height: 80px;

      resize: none;
      /* disable user resizing */
      overflow: auto;
      /* show scrollbar instead */
      box-sizing: border-box;
      /* keep 80px including padding/border */
    }


    /* ---- Put tabs back in the document flow (not floating) ---- */
    #customerPage .tabs {
      position: static !important;
      top: auto !important;
      left: auto !important;
      transform: none !important;
      z-index: auto !important;

      /* restore original spacing */
      padding: 0 !important;
      background: transparent !important;
    }

    body.is-customer #customerPage .wrap {
      margin-top: 16px !important;
    }

    @media (max-width: 900px) {
      #customerPage .tabs {
        top: auto !important;
      }

      body.is-customer #customerPage .wrap {
        margin-top: 12px !important;
      }
    }
/* Lock the floating "Customer Overview" tab in place */
#fixedAddClient{ transform:none !important; will-change:auto !important; }
#fixedAddClient .tab,
#fixedAddClient .tab:hover,
#fixedAddClient .tab:active{
  transform:none !important;
  transition:none !important;
}
</style>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>

<body>
  <header>
    <img class="logo"
      src="https://raw.githubusercontent.com/Domichico20/Best-Turizo-Insurace-Software/11806dd4d5912b98aaba1ae08428968a18b2fa8a/logo.png"
      alt="Logo" />
  </header>

  <!-- ===== Login (unchanged) ===== -->
  <div id="loginSection">
    <input type="text" id="appUser" placeholder="Enter Username" />
    <input type="password" id="appPassword" placeholder="Enter Password"
      onkeydown="if(event.key==='Enter'){event.preventDefault();checkPassword();}">
    <button onclick="checkPassword()">Unlock</button>
  </div>

  <div id="appSection" style="display:none;">
<div id="fixedAddClient" style="position:fixed; top:8px; right:12px; z-index:3000;">
<button type="button" class="tab" onclick="startAddClient()" style="transform:none; transition:none;">
  Customer Overview
</button>
    </div>


    <form id="searchForm" onsubmit="event.preventDefault(); searchData();">
      <div id="searchSection">
        <input type="text" id="searchQuery" placeholder="Search by Policy #, Insurance, Name, Phone, Email, Notes">
        <button type="submit" class="search-btn">Search</button>
        <!-- NEW -->
        <button type="button" class="search-btn" id="refreshBtn" onclick="refreshData()">Refresh</button>
      </div>
    </form>



    <table id="dataTable">
      <thead>
        <tr>
          <th>Policy #</th>
          <th>Insurer</th>
          <th>Effective</th>
          <th>Expiration</th>
          <th>Status</th>
          <th>First</th>
          <th>Last</th>
          <th>Address</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Go</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ===== Customer Overview Page ===== -->
  <div id="customerPage" style="display:none;">
    <div class="wrap">
      <div class="topbar">
        <div class="title" style="margin-right:12px;">Customer Overview</div>
      </div>


      <div class="tabs" role="tablist">
        <button class="tab" id="tabbtn-main" role="tab" aria-selected="false" onclick="goMainTab()">Main Page</button>
        <button class="tab" id="tabbtn-info" role="tab" aria-controls="tab-info" aria-selected="true"
          onclick="switchTab('info')">Customer Info</button>
        <button class="tab" id="tabbtn-policies" role="tab" aria-controls="tab-policies" aria-selected="false"
          onclick="switchTab('policies')">Policies</button>
        <button class="tab" id="tabbtn-files" role="tab" aria-controls="tab-files" aria-selected="false"
          onclick="switchTab('files')">Files</button>
        <button class="tab" id="tabbtn-accord" role="tab" aria-controls="tab-accord" aria-selected="false"
          onclick="switchTab('accord')">Accord</button>
        <button class="tab" id="tabbtn-notes" role="tab" aria-controls="tab-notes" aria-selected="false"
          onclick="switchTab('notes')">Notes</button>
        <button class="tab" id="tabbtn-addclient" type="button" onclick="startAddClient()">Add Client</button>
      </div>


      <div class="grid" id="custDetailsGrid"></div>

      <!-- Customer Info panel -->
      <!-- Customer Info panel -->
      <section id="tab-info" class="tabpanel active" role="tabpanel" aria-labelledby="tabbtn-info">
        <div class="form" id="custInfoForm">
          <div class="fg row-3"><label>Policy #</label><input id="ci_policy"></div>
          <div class="fg row-3"><label>Insurer</label><input id="ci_insurer"></div>

          <!-- Use type="text" so Flatpickr shows the same calendar as Policies -->
          <div class="fg row-3"><label>Effective</label><input id="ci_effDate" type="text" placeholder="YYYY-MM-DD">
          </div>
          <div class="fg row-3"><label>Expiration</label><input id="ci_expDate" type="text" placeholder="YYYY-MM-DD">
          </div>

          <div class="fg row-3"><label>First Name</label><input id="ci_firstName"></div>
          <div class="fg row-3"><label>Last Name</label><input id="ci_lastName"></div>
          <div class="fg row-6"><label>Address</label><input id="ci_address"></div>

          <div class="fg row-3"><label>Phone</label><input id="ci_phone"></div>
          <div class="fg row-3"><label>Email</label><input id="ci_email" type="email"></div>

          <div class="fg row-3"><label>Year</label><input id="ci_year"></div>
          <div class="fg row-3"><label>Make</label><input id="ci_make"></div>
          <div class="fg row-3"><label>Model</label><input id="ci_model"></div>
          <div class="fg row-3"><label>Vin #</label><input id="ci_vin"></div>
        </div>

        <div class="actionbar">
          <button class="btn primary" onclick="saveCustomerInfo()">Save</button>
          <button class="btn primary" onclick="addCriticalAlert()">Critical Alert</button>
        </div>
      </section>


      <!-- Policies panel -->
      <!-- Policies panel -->
      <section id="tab-policies" class="tabpanel" role="tabpanel" aria-labelledby="tabbtn-policies">

        <table class="themed-table" id="policiesTable">
          <thead>
            <tr>
              <th>Line of Business</th>
              <th>Policy #</th>
              <th>Carrier</th>
              <th>Effective</th>
              <th>Expiration</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>

        <div class="attc-emptystate" id="policiesEmpty" style="display:none;">No policies found for this contact.</div>

        <div class="actionbar" style="justify-content:flex-start;">
          <button class="tab" onclick="startAddPolicy()">Add Policy</button>
          <button class="tab" onclick="startEditPolicy()">Edit Policy</button>
        </div>

        <!-- Inline editor -->
        <div id="policyEditor" style="display:none; margin-top:12px;">

          <div class="form">
            <div class="fg row-3">
              <label>Line of Business</label>
              <select id="pe_lob">
                <option value="">‚Äî Select ‚Äî</option>
                <option>Home Owners</option>
                <option>Personal Auto</option>
                <option>Commercial Auto</option>
                <option>General Liability</option>
                <option>Worker's Comp</option>
                <option>Other</option>
              </select>
            </div>
            <div class="fg row-3"><label>Policy #</label><input id="pe_policy"></div>
            <div class="fg row-3"><label>Insurer</label><input id="pe_insurer"></div>
            <div class="fg row-3"><label>Effective</label><input id="pe_effDate" type="text" placeholder="YYYY-MM-DD">
            </div>
            <div class="fg row-3"><label>Expiration</label><input id="pe_expDate" type="text" placeholder="YYYY-MM-DD">
            </div>

            <div class="fg row-6"><label>Address</label><input id="pe_address"></div>
            <div class="fg row-3"><label>Phone</label><input id="pe_phone"></div>
            <div class="fg row-3"><label>Email</label><input id="pe_email" type="email"></div>
            <div class="fg row-3"><label>First Name</label><input id="pe_firstName"></div>
            <div class="fg row-3"><label>Last Name</label><input id="pe_lastName"></div>
            <div class="fg row-3"><label>Year</label><input id="pe_year"></div>
            <div class="fg row-3"><label>Make</label><input id="pe_make"></div>
            <div class="fg row-3"><label>Model</label><input id="pe_model"></div>
            <div class="fg row-3"><label>Vin #</label><input id="pe_vin"></div>
          </div>
          <div class="actionbar">
            <button class="btn primary" id="pe_save" onclick="savePolicyEditor()">Save Policy</button>
            <button class="btn primary" onclick="cancelPolicyEditor()">Cancel</button>
          </div>
        </div>
      </section>


      <!-- Files -->
      <section id="tab-files" class="tabpanel" role="tabpanel" aria-labelledby="tabbtn-files">
        <div class="attc-upload">
          <label for="policyUpload" class="attc-dropzone" id="policyDrop">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path
                d="M19 15a4 4 0 0 0-3.8-2.99A5 5 0 0 0 6 12a4 4 0 0 0-1 7.87V20h13a3 3 0 0 0 1-5.81zM12 6v8m0 0l-3-3m3 3l3-3"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <div class="text">
              <strong>Upload PDF</strong>
              <span>Drag & drop your file or click to browse</span>
            </div>
            <div class="meta">PDF only ‚Ä¢ up to 20MB</div>
          </label>
          <input id="policyUpload" class="hid-input" type="file" accept="application/pdf">
          <div class="attc-file" id="policyFileMeta"></div>
        </div>

        <table class="themed-table" id="policyTable">
          <thead>
            <tr>
              <th>File Name</th>
              <th>Date Added</th>
              <th>Added By</th>
              <th>Policy #</th>
              <th>View</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="attc-emptystate" id="policyEmpty" style="display:none;">No policy forms uploaded yet.</div>
      </section>

      <!-- Accord -->
      <!-- Accord -->
      <section id="tab-accord" class="tabpanel" role="tabpanel" aria-labelledby="tabbtn-accord">
        <div class="attc-upload">
          <label for="accordUpload" class="attc-dropzone" id="accordDrop">
            <svg viewBox="0 0 24 24" aria-hidden="true">
              <path
                d="M19 15a4 4 0 0 0-3.8-2.99A5 5 0 0 0 6 12a4 4 0 0 0-1 7.87V20h13a3 3 0 0 0 1-5.81zM12 6v8m0 0l-3-3m3 3l3-3"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <div class="text">
              <strong>Upload PDF</strong>
              <span>Drag & drop your file or click to browse</span>
            </div>
            <div class="meta">PDF only ‚Ä¢ up to 20MB</div>
          </label>
          <input id="accordUpload" class="hid-input" type="file" accept="application/pdf">
          <div class="attc-file" id="accordFileMeta"></div>
        </div>

        <!-- Editable viewer + save-as-new -->
        <div style="margin:12px 0; border:1px solid #e5e7eb; border-radius:12px; overflow:hidden; background:#fff;">
          <div
            style="display:flex; align-items:center; justify-content:space-between; padding:10px 12px; background:#fbf7f0; border-bottom:1px solid #eadcc6;">
            <strong>Accord Template (Editable)</strong>
            <div>
              <input id="accordEditedFile" class="hid-input" type="file" accept="application/pdf">
              <label for="accordEditedFile" class="btn" style="margin-right:8px;">Choose Edited PDF</label>
              <button class="btn primary" type="button" onclick="uploadEditedAccord()">Save Edited Form</button>
            </div>
          </div>
          <div id="accordViewerWrap" style="height:70vh; background:#fff;"></div>
        </div>

        <table class="themed-table" id="accordTable">
          <thead>
            <tr>
              <th>File Name</th>
              <th>Date Added</th>
              <th>Added By</th>
              <th>Policy #</th>
              <th>View</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="attc-emptystate" id="accordEmpty" style="display:none;">No accord forms uploaded yet.</div>
      </section>

      <!-- Notes -->
      <section id="tab-notes" class="tabpanel" role="tabpanel" aria-labelledby="tabbtn-notes">
        <div class="form">
          <div class="fg row-full">
            <textarea id="noteInput" rows="2" placeholder="Add New Note Here"></textarea>
          </div>
        </div>
        <div class="actionbar">
          <button class="btn primary" onclick="addNoteFromTab()">Add Note</button>
        </div>

        <h3>Notes</h3>
        <div id="notesList" class="notes-list"></div>
        <!-- pager removed; notes list scrolls -->

      </section>
    </div>
  </div>

  <script>

    function refreshData() {
      // clear search box
      const q = document.getElementById('searchQuery');
      if (q) q.value = '';

      // clear selection highlight on the table
      const tbody = document.querySelector('#dataTable tbody');
      if (tbody) tbody.querySelectorAll('tr.selected').forEach(el => el.classList.remove('selected'));

      // forget selected row and reload fresh data (uses your 15-day filter)
      selectedRowIndex = null;

      // optional quick feedback while reloading
      if (tbody) {
        tbody.innerHTML = `<tr><td colspan="11" style="text-align:center; padding:12px;">Refreshing‚Ä¶</td></tr>`;
      }

      // pull again from Sheets and re-render
      loadData();
    }

    /* ===== Config / Constants ===== */
    const ROW_LIMIT = 25;
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyxC9XhJ-ygxv9V2PqaB26_wvNSgsPBUiZQ4e4CLafx3IT2Kn6tpKyMN0e7oHMn9IvT/exec';
    const sheetId = '1q94KS8Dc2usWKc0h6iQvHP1sDfsPbgcybzXs4zpZANc';
    const apiKey = 'AIzaSyAhaKX_GIaCIXBsq43J3aMvqtGtFngdzrQ';
    const range = 'policies!A1:ZZZ'; // pull all columns, incl. Policy/Accord Forms

    const USERS = { Edwin: 'Insurance2025', Islendy: 'Insurance2026', Penelope: 'Insurance2027' };

    // ‚¨áÔ∏è Put your Accord template PDF URL here (kept visible for editing in the Accord tab)
    const ACCORD_TEMPLATE_URL = ""; // e.g. "https://your-domain.com/forms/ACORD-25.pdf"

    const PDF_ICON_SVG = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" role="img" aria-label="PDF"><rect x="3" y="2" width="18" height="20" rx="2" fill="#e53935"/><polygon points="16,2 21,2 21,7" fill="#ffffff" opacity="0.9"/><text x="12" y="16" text-anchor="middle" font-family="Arial,Helvetica,sans-serif" font-size="8" font-weight="700" fill="#ffffff">PDF</text></svg>`;
    // Cache header names and per-row objects so we don't refetch on "GO"
    let headers = [];
    const rowCache = new Map(); // key: sheet row number, value: object keyed by header

    function rowToObj(arr) {
      const o = {};
      headers.forEach((h, i) => (o[h] = arr[i] ?? ''));
      return o;
    }



    // session state
    let sessionPassword = "", sessionUser = "", selectedRowIndex = null; // sheet row number (1-based)
    let allDataRows = []; // [{r:[], sheetRow:n}]

    // Notes pagination state
    let notesArray = [];

    /* ===== Utilities ===== */
    function setZoomLevel() { document.body.style.zoom = '100%'; }
    document.addEventListener('DOMContentLoaded', setZoomLevel);

    // WhatsApp helpers (click-to-chat everywhere we display a phone)
    function digitsOnly(s) { return String(s || "").replace(/\D/g, ""); }
    function phoneLinkHTML(raw) {
      const d = digitsOnly(raw);
      if (!d) return "";
      const wa = d.length === 10 ? ("1" + d) : (d.length === 11 && d.startsWith("1") ? d : d);
      const text = raw || d;
      return `<a href="https://wa.me/${wa}" target="_blank" rel="noopener">${text}</a>`;
    }

    async function postToScript(params, timeoutMs = 60000) {
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort('timeout'), timeoutMs);
      try {
        const res = await fetch(scriptURL, {
          method: 'POST',
          body: new URLSearchParams(params),
          signal: ctrl.signal,
        });
        const text = await res.text();
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${text}`);
        return text;
      } finally {
        clearTimeout(t);
      }
    }



    window.checkPassword = function () {
      const userEl = document.getElementById('appUser');
      const passEl = document.getElementById('appPassword');
      const loginEl = document.getElementById('loginSection');
      const appEl = document.getElementById('appSection');

      const u = (userEl?.value || '').trim();
      const p = (passEl?.value || '').trim();

      if (USERS[u] === p) {
        sessionUser = u;
        sessionPassword = p;
        loginEl.style.display = 'none';
        appEl.style.display = 'block';
        loadData();
        setTimeout(setZoomLevel, 100);
        return true;
      }
      alert('Incorrect username or password');
      return false;
    };

    // Dates / status helpers
    function parseExpDate(v) { if (!v) return null; const d = new Date(String(v).trim()); return isNaN(d.getTime()) ? null : d; }
    function compareByExpiration(a, b) { const da = parseExpDate(a.r[3]); const db = parseExpDate(b.r[3]); if (da && db) return da - db; if (da && !db) return -1; if (!da && db) return 1; return 0; }
    function computeStatus(exp) { const d = parseExpDate(exp); if (!d) return 'Inactive'; const today = new Date(); today.setHours(0, 0, 0, 0); return (d >= today) ? 'Active' : 'Inactive'; }
    function statusBadge(status) { const cls = status === 'Active' ? 'active' : 'inactive'; return `<span class="badge ${cls}">${status}</span>`; }
    // Normalize any sheet date string to "YYYY-MM-DD" for <input type="date">
    function toYMD(v) {
      if (!v) return '';
      const d1 = new Date(String(v));
      if (!isNaN(d1.getTime())) {
        const y = d1.getFullYear();
        const m = String(d1.getMonth() + 1).padStart(2, '0');
        const d = String(d1.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
      }
      const m = String(v).match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
      if (m) {
        const y = m[3].length === 2 ? (Number(m[3]) + 2000) : Number(m[3]);
        return `${y}-${String(m[1]).padStart(2, '0')}-${String(m[2]).padStart(2, '0')}`;
      }
      return '';
    }

    // helper to read a sheet cell by case/space-insensitive aliases
    // helper to read a sheet cell by case/space-insensitive aliases
    // helper to read a sheet cell by case/space-insensitive aliases (also strips zero-width spaces)
    function getCell(row, ...aliases) {
      const norm = s => String(s).toLowerCase().replace(/[\s\u200B-\u200D\uFEFF]/g, '');
      const keys = Object.keys(row || {});
      for (const k of keys) {
        if (aliases.some(a => norm(k) === norm(a))) return row[k];
      }
      return '';
    }


    // Robust reader for "Line of Business" that tries row object first,
    // then falls back to the raw array using the header index.
    // Robust reader for "Line of Business":
    // 1) read by common header names; 2) fallback by header index; 3) fallback from Notes tag: "LOB: ...".
    function readLOBForRow(rowObj, rowArray) {
      // 1) object by aliases
      const fromObj = getCell(
        rowObj,
        'Line of Business',
        'LineOfBusiness',
        'Business Line',
        'BusinessLine',
        'LOB',
        'businessLine',
        'line_of_business',
        'lineofbusiness',
        'line-of-business'
      );
      if (fromObj) return fromObj;

      // 2) header index fallback
      try {
        const norm = s => String(s || '').toLowerCase().replace(/[\s\u200B-\u200D\uFEFF]/g, '');
        const target = 'lineofbusiness';
        const idx = headers.findIndex(h => norm(h) === target);
        if (idx >= 0 && rowArray && rowArray[idx] != null) return rowArray[idx];
      } catch (_) { }

      // 3) parse Notes tag "LOB: ..."
      const notes = getCell(rowObj, 'Notes', 'Note', 'Notes Log');
      const m = String(notes || '').match(/(?:^|\n)\s*(?:LOB|Line\s*of\s*Business)\s*:\s*([^\n]+)/i);
      if (m) return m[1].trim();

      return '';
    }





    function loadData() {
      return fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}&fields=values`)
        .then(res => res.json())
        .then(data => {
          const rows = data.values || [];
          headers = rows[0] || [];
          const body = rows.slice(1).map((r, idx) => {
            const rowNum = idx + 2;                // 1-based in sheet
            rowCache.set(rowNum, rowToObj(r));     // cache as object for instant use later
            return { r, sheetRow: rowNum };
          });

          allDataRows = body;

          // show from 15 days prior onward (fewer rows = faster)
          const cutoff = new Date();
          cutoff.setDate(cutoff.getDate() - 15);
          cutoff.setHours(0, 0, 0, 0);

          const visible = body.filter(o => {
            const d = parseExpDate(o.r[3]);
            return d && d >= cutoff;
          });

          visible.sort(compareByExpiration);

          document.getElementById('searchQuery').value = '';
          renderTable(visible.slice(0, ROW_LIMIT));
        })
        .catch(err => {
          console.error(err);
          alert('Could not load data. Check API key, sheetId, and sharing.');
        });
    }




    function renderTable(rows) {
      const tbody = document.querySelector('#dataTable tbody');
      let html = '';
      for (const o of rows) {
        const r = o.r;
        const status = computeStatus(r[3]);
        const phoneHTML = phoneLinkHTML(r[7] ?? '');
        html += `
      <tr data-row="${o.sheetRow}">
        <td>${r[0] ?? ''}</td>
        <td>${r[1] ?? ''}</td>
        <td>${r[2] ?? ''}</td>
        <td>${r[3] ?? ''}</td>
        <td>${statusBadge(status)}</td>
        <td>${r[4] ?? ''}</td>
        <td>${r[5] ?? ''}</td>
        <td>${r[6] ?? ''}</td>
        <td>${phoneHTML}</td>
        <td>${r[8] ?? ''}</td>
        <td><button class="go-btn" data-row="${o.sheetRow}">Go</button></td>
      </tr>`;
      }
      tbody.innerHTML = html;
    }



    function searchData() {
      const q = document.getElementById('searchQuery').value.toLowerCase().trim();
      if (!q) { renderTable(allDataRows.slice(0, ROW_LIMIT)); return; }

      const filtered = allDataRows.filter(o => (o.r.join(' ') || '').toLowerCase().includes(q));
      filtered.sort(compareByExpiration);
      renderTable(filtered);
    }
    let custRowNum = null, custRowObj = null; // current row in overview
    let peMode = 'add', peEditRow = null;     // policies editor state
    let isAddingClient = false;               // add-client mode
    let selectedPolicyRow = null;             // highlighted policy row



    function openCustomerPage(openTab = 'info', addMode = false, explicitRow = null) {
      isAddingClient = false;                   //
      const rowNum = explicitRow ?? selectedRowIndex;
      if (!rowNum) { alert('Select a row first.'); return; }
      custRowNum = rowNum;
      toggleAddClientFields(false);  // show fields for existing clients


      // Use cached data immediately (no network)
      custRowObj = rowCache.get(rowNum) || {};
      renderCustomerHeader(custRowObj);
      fillCustomerInfo(custRowObj);

      // Related policies from the already loaded table
      renderPoliciesOfContact();

      // Show the page right away
      showPage('customer');
      switchTab(addMode ? 'policies' : openTab);
      if (addMode) startAddPolicy(true);

      // Notes immediately; defer heavy attachments
      rebuildNotes(custRowObj['Notes'] || custRowObj['Note'] || custRowObj['Notes Log'] || '');

      if (custRowObj['Policy Forms'] || custRowObj['Accord Forms']) {
        renderAttachmentTable('policy', custRowObj['Policy Forms'] || '[]');
        renderAttachmentTable('accord', custRowObj['Accord Forms'] || '[]');
      } else {
        postToScript({ action: 'getRow', password: sessionPassword, row: custRowNum })
          .then(txt => {
            const p = JSON.parse(txt);
            if (p && p.ok) {
              custRowObj = p.row;
            }
          })
          .finally(() => {
            renderAttachmentTable('policy', custRowObj['Policy Forms'] || '[]');
            renderAttachmentTable('accord', custRowObj['Accord Forms'] || '[]');
          });
      }

      // üî¥ If there‚Äôs a critical alert, prompt with Keep/Delete
      promptCriticalAlertIfAny(custRowObj);
    }


    function closeCustomerPage() { showPage('app'); setTimeout(setZoomLevel, 50); }
    function goMainTab() { closeCustomerPage(); }   // used by the "Main Page" tab

    // Start a brand-new client (clears form; Save will ADD)
    function startAddClient() {
      isAddingClient = true;
      selectedRowIndex = null;
      custRowNum = null;
      custRowObj = {};

      showPage('customer');
      switchTab('info');
      toggleAddClientFields(true);   // hide 7 inputs while adding a client


      // Clear the editable form (bottom section)
      document.querySelectorAll('#custInfoForm input').forEach(el => el.value = '');

      // Clear the summary cards (top section)
      renderCustomerHeader({});   // draws empty cards

      // Hide & clear the policy editor
      const pe = document.getElementById('policyEditor');
      if (pe) pe.style.display = 'none';
      ['pe_lob', 'pe_policy', 'pe_insurer', 'pe_effDate', 'pe_expDate', 'pe_address', 'pe_phone', 'pe_email', 'pe_firstName', 'pe_lastName', 'pe_year', 'pe_make', 'pe_model', 'pe_vin']
        .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });

      // Clear policies table
      const ptb = document.querySelector('#policiesTable tbody');
      if (ptb) ptb.innerHTML = '';
      const pempty = document.getElementById('policiesEmpty');
      if (pempty) pempty.style.display = 'block';

      // Clear files/accord lists
      renderAttachmentTable('policy', '[]');
      renderAttachmentTable('accord', '[]');

      // Clear notes (incl. any critical banner)
      rebuildNotes('');
    }


    function showPage(which) {
      document.getElementById('appSection').style.display = (which === 'app') ? 'block' : 'none';
      document.getElementById('customerPage').style.display = (which === 'customer') ? 'block' : 'none';

      // Show the logo only on Login + Main (list) pages
      document.body.classList.toggle('is-customer', which === 'customer');
    }

 function switchTab(name) {
  ['info', 'policies', 'files', 'accord', 'notes'].forEach(n => {
    const el = document.getElementById(`tab-${n}`);
    const btn = document.getElementById(`tabbtn-${n}`);
    if (el) el.classList.toggle('active', n === name);
    if (btn) btn.setAttribute('aria-selected', n === name ? 'true' : 'false');
  });

  // Add a hook so CSS can hide the first 4 summary cards only on Customer Info
  const cp = document.getElementById('customerPage');
  if (cp) cp.classList.toggle('info-active', name === 'info');
}




    // header summary grid
    function renderCustomerHeader(row) {
      const grid = document.getElementById('custDetailsGrid');

const fields = [
  ['Policy #', () => getCell(row, 'Policy #')],
  ['Insurer', () => getCell(row, 'Insurer')],
  ['Effective', () => getCell(row, 'Effective Date', 'Effective')],
  ['Expiration', () => getCell(row, 'Expiration Date', 'Expiration')],
  ['First', () => getCell(row, 'First Name', 'First')],
  ['Last', () => getCell(row, 'Last Name', 'Last')],
  ['Address', () => getCell(row, 'Address')],
  ['Phone', () => getCell(row, 'Phone')],
  ['Email', () => getCell(row, 'Email')]
];



      // Hide these 4 cards only when adding a new client
      const list = isAddingClient
        ? fields.filter(([label]) => !(['Policy #', 'Insurer', 'Effective', 'Expiration'].includes(label)))
        : fields;

      grid.innerHTML = '';
      list.forEach(([label, getter]) => {
        const card = document.createElement('div');
        card.className = 'card';

        const lab = document.createElement('div');
        lab.className = 'label';
        lab.textContent = label;

        const val = document.createElement('div');
        val.className = 'value';
        const v = getter() || '';

        if (label === 'Phone' && v) {
          val.innerHTML = phoneLinkHTML(v);
        } else {
          val.textContent = v;
        }

        card.append(lab, val);
        grid.append(card);
      });
    }


    /* ===== Customer Info ===== */
    function fillCustomerInfo(row) {
      const g = id => document.getElementById(id);
      g('ci_policy').value = row['Policy #'] || '';
      g('ci_insurer').value = row['Insurer'] || '';
      g('ci_effDate').value = toYMD(getCell(row, 'Effective Date', 'Effective'));
      g('ci_expDate').value = toYMD(getCell(row, 'Expiration Date', 'Expiration'));
      g('ci_firstName').value = row['First Name'] || row['First'] || '';
      g('ci_lastName').value = row['Last Name'] || row['Last'] || '';
      g('ci_address').value = row['Address'] || '';
      g('ci_phone').value = row['Phone'] || '';
      g('ci_email').value = row['Email'] || '';
      g('ci_year').value = row['Year'] || '';
      g('ci_make').value = row['Make'] || '';
      g('ci_model').value = row['Model'] || '';
      g('ci_vin').value = row['Vin #'] || '';
    }
    function toggleAddClientFields(hide) {
const ids = ['ci_policy','ci_insurer','ci_effDate','ci_expDate','ci_year','ci_make','ci_model','ci_vin'];
      ids.forEach(id => {
        const el = document.getElementById(id);
        const fg = el ? el.closest('.fg') : null;
        if (fg) fg.style.display = hide ? 'none' : '';
      });
    }

    function saveCustomerInfo() {
      const g = id => document.getElementById(id).value.trim();
      const payload = {
        policy: g('ci_policy'), insurer: g('ci_insurer'),
        effDate: g('ci_effDate'), expDate: g('ci_expDate'),
        firstName: g('ci_firstName'), lastName: g('ci_lastName'),
        address: g('ci_address'), phone: g('ci_phone'), email: g('ci_email'),
        year: g('ci_year'), make: g('ci_make'), model: g('ci_model'), vin: g('ci_vin'),
        notes: custRowObj ? (custRowObj['Notes'] || '') : ''
      };

      if (isAddingClient || !custRowNum) {
        // ADD new client, but stay on the page and show in the header
        postToScript({ action: 'add', password: sessionPassword, ...payload })
          .then(() => {
            alert('Client added');
            isAddingClient = false;
            toggleAddClientFields(false);  // reveal fields after client is created


            // Update top cards immediately from what we just saved
            custRowObj = {
              'Policy #': payload.policy,
              'Insurer': payload.insurer,
              'Effective Date': payload.effDate,
              'Expiration Date': payload.expDate,
              'First Name': payload.firstName,
              'Last Name': payload.lastName,
              'Address': payload.address,
              'Phone': payload.phone,
              'Email': payload.email,
              'Year': payload.year,
              'Make': payload.make,
              'Model': payload.model,
              'Vin #': payload.vin,
              'Notes': payload.notes
            };
            renderCustomerHeader(custRowObj);
            fillCustomerInfo(custRowObj);

            // Reload data and try to locate the new sheet row so future "Save" does EDIT
            return loadData().then(() => {
              const match = allDataRows.find(o => {
                const r = o.r;
                return (String(r[0] || '').trim() === payload.policy) &&
                  (String(r[8] || '').trim() === payload.email) &&
                  (String(r[4] || '').trim().toLowerCase() === String(payload.firstName || '').toLowerCase()) &&
                  (String(r[5] || '').trim().toLowerCase() === String(payload.lastName || '').toLowerCase());
              });
              if (match) {
                custRowNum = match.sheetRow;
                custRowObj = rowCache.get(custRowNum) || custRowObj;
                renderCustomerHeader(custRowObj);
              }
            });
          })
          .catch(err => alert(err.message));
      } else {
        // EDIT existing
        postToScript({ action: 'edit', password: sessionPassword, row: custRowNum, ...payload })
          .then(() => {
            alert('Saved');
            return loadData().then(() => openCustomerPage('info', false, custRowNum));
          })
          .catch(err => alert(err.message));
      }
    }


    function renderPoliciesOfContact() {
      const tbody = document.querySelector('#policiesTable tbody');
      const empty = document.getElementById('policiesEmpty');
      tbody.innerHTML = '';
      selectedPolicyRow = null;

      if (!custRowObj) { empty.style.display = 'block'; return; }

      const first = (custRowObj['First Name'] || custRowObj['First'] || '').toLowerCase();
      const last = (custRowObj['Last Name'] || custRowObj['Last'] || '').toLowerCase();
      const phone = (custRowObj['Phone'] || '').replace(/\D/g, '');

      const matches = allDataRows.filter(o => {
        const r = o.r;
        const f = (r[4] || '').toLowerCase();
        const l = (r[5] || '').toLowerCase();
        const p = (r[7] || '').replace(/\D/g, '');
        return (f === first && l === last) || (p && phone && p === phone);
      });

      if (!matches.length) { empty.style.display = 'block'; return; }
      empty.style.display = 'none';

      matches.forEach(o => {
        const r = o.r;
        const rObj = rowCache.get(o.sheetRow) || {};
        const lob = readLOBForRow(rObj, r);
        const st = computeStatus(r[3]);

        const tr = document.createElement('tr');
        tr.dataset.row = o.sheetRow;

        // click to select + highlight this row
        tr.addEventListener('click', () => {
          selectedPolicyRow = o.sheetRow;
          const tb = tr.parentElement;
          if (tb) tb.querySelectorAll('tr.selected').forEach(el => el.classList.remove('selected'));
          tr.classList.add('selected');
        });

        [lob, r[0] || '', r[1] || '', r[2] || '', r[3] || '', statusBadge(st)].forEach(v => {
          const td = document.createElement('td');
          td.innerHTML = v;
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });
    }



    function startAddPolicy(preselect = true) {
      peMode = 'add';
      peEditRow = null;
      document.getElementById('policyEditor').style.display = 'block';

      // clear all policy editor fields
      ['pe_lob', 'pe_policy', 'pe_insurer', 'pe_effDate', 'pe_expDate', 'pe_address', 'pe_phone', 'pe_email', 'pe_firstName', 'pe_lastName', 'pe_year', 'pe_make', 'pe_model', 'pe_vin']
        .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });

      // optional prefill from current contact
      if (preselect && custRowObj) {
        const g = id => document.getElementById(id);
        g('pe_firstName').value = custRowObj['First Name'] || custRowObj['First'] || '';
        g('pe_lastName').value = custRowObj['Last Name'] || custRowObj['Last'] || '';
        g('pe_address').value = custRowObj['Address'] || '';
        g('pe_phone').value = custRowObj['Phone'] || '';
        g('pe_email').value = custRowObj['Email'] || '';
      }
    }


    function cancelPolicyEditor() { document.getElementById('policyEditor').style.display = 'none'; }

    // ‚úÖ NEW: populate inline editor from the selected policy row
    function startEditPolicy() {
      const row = selectedPolicyRow;
      if (!row) { alert('Click a policy row first'); return; }

      const rowObj = rowCache.get(row) || {};
      const arrMatch = allDataRows.find(o => o.sheetRow === row);
      const rowArr = arrMatch ? arrMatch.r : [];

      peMode = 'edit';
      peEditRow = row;
      document.getElementById('policyEditor').style.display = 'block';

      const g = id => document.getElementById(id);
      g('pe_lob').value = readLOBForRow(rowObj, rowArr) || '';
      g('pe_policy').value = rowObj['Policy #'] || '';
      g('pe_insurer').value = rowObj['Insurer'] || '';
      g('pe_effDate').value = toYMD(getCell(rowObj, 'Effective Date', 'Effective'));
      g('pe_expDate').value = toYMD(getCell(rowObj, 'Expiration Date', 'Expiration'));
      g('pe_address').value = rowObj['Address'] || '';
      g('pe_phone').value = rowObj['Phone'] || '';
      g('pe_email').value = rowObj['Email'] || '';
      g('pe_firstName').value = rowObj['First Name'] || rowObj['First'] || '';
      g('pe_lastName').value = rowObj['Last Name'] || rowObj['Last'] || '';
      g('pe_year').value = rowObj['Year'] || '';
      g('pe_make').value = rowObj['Make'] || '';
      g('pe_model').value = rowObj['Model'] || '';
      g('pe_vin').value = rowObj['Vin #'] || '';
    }

    function savePolicyEditor() {
      const g = id => document.getElementById(id).value.trim();
      const lobVal = g('pe_lob');

      // Build notes that keep any existing notes but ensure a single "LOB: <value>" line at the top.
      let existingNotes = '';
      if (peMode === 'edit') {
        const ro = rowCache.get(peEditRow) || {};
        existingNotes = ro['Notes'] || ro['Note'] || ro['Notes Log'] || '';
      } else {
        existingNotes = (custRowObj && (custRowObj['Notes'] || custRowObj['Note'] || custRowObj['Notes Log'])) || '';
      }
      const withoutOldLOB = String(existingNotes)
        .split('\n')
        .filter(line => !/^\s*(?:LOB|Line\s*of\s*Business)\s*:/i.test(line))
        .join('\n')
        .trim();
      const notesWithLOB = lobVal ? (`LOB: ${lobVal}` + (withoutOldLOB ? `\n${withoutOldLOB}` : '')) : withoutOldLOB;

      const payload = {
        policy: g('pe_policy'),
        insurer: g('pe_insurer'),
        effDate: g('pe_effDate'),
        expDate: g('pe_expDate'),
        firstName: g('pe_firstName'),
        lastName: g('pe_lastName'),
        address: g('pe_address'),
        phone: g('pe_phone'),
        email: g('pe_email'),
        year: g('pe_year'),
        make: g('pe_make'),
        model: g('pe_model'),
        vin: g('pe_vin'),

        // Send every common alias for LOB (for whatever your Apps Script expects)
        lineOfBusiness: lobVal,
        LineOfBusiness: lobVal,
        'Line of Business': lobVal,
        'Business Line': lobVal,
        lob: lobVal,
        businessLine: lobVal,
        line_of_business: lobVal,

        // Persist LOB even if backend doesn't have a LOB column yet
        notes: notesWithLOB
      };

      const refreshAll = () =>
        loadData().then(() => {
          if (custRowNum) openCustomerPage('policies', false, custRowNum);
          else switchTab('policies');
        });

      if (peMode === 'add') {
        if (!payload.policy) { alert('Policy # is required'); return; }

        const existing = allDataRows.find(o => {
          const policyMatch = String(o.r[0] || '').trim().toLowerCase() === payload.policy.trim().toLowerCase();
          const carrierMatch = String(o.r[1] || '').trim().toLowerCase() === payload.insurer.trim().toLowerCase();
          return policyMatch && carrierMatch;
        });

        const apply = (action, extra = {}) => postToScript({ action, password: sessionPassword, ...extra, ...payload });

        (existing ? apply('edit', { row: existing.sheetRow }) : apply('add'))
          .then(() => {
            alert(existing ? 'Policy updated' : 'Policy added');
            document.getElementById('policyEditor').style.display = 'none';
            return refreshAll();
          })
          .catch(err => alert(err.message));
      } else {
        postToScript({ action: 'edit', password: sessionPassword, row: peEditRow, ...payload })
          .then(() => {
            alert('Policy updated');
            document.getElementById('policyEditor').style.display = 'none';
            return refreshAll();
          })
          .catch(err => alert(err.message));
      }
    }

    function deletePolicy() {
      const row = selectedPolicyRow;
      if (!row) { alert('Click a policy row to delete'); return; }
      if (!confirm('Delete this policy permanently?')) return;

      postToScript({ action: 'delete', password: sessionPassword, row })
        .then(() => { alert('Policy deleted'); loadData(); renderPoliciesOfContact(); })
        .catch(async (err) => {
          try {
            await postToScript({ action: 'deleteRow', password: sessionPassword, row });
            alert('Policy deleted');
            loadData();
            renderPoliciesOfContact();
          } catch (e) {
            alert((err && err.message) || (e && e.message) || 'Delete failed');
          }
        });
    }




    /* ===== Files / Accord ===== */
    function renderAttachmentTable(kind, jsonCell) {
      const isPolicy = (kind === 'policy');
      const tbody = document.getElementById(isPolicy ? 'policyTable' : 'accordTable').querySelector('tbody');
      const empty = document.getElementById(isPolicy ? 'policyEmpty' : 'accordEmpty');
      let items = []; try { items = jsonCell ? JSON.parse(jsonCell) : []; } catch (e) { items = []; }
      tbody.innerHTML = ''; if (!items.length) { empty.style.display = 'block'; return; }
      empty.style.display = 'none';
      items.forEach(meta => {
        const tr = document.createElement('tr');
        ['name', 'addedAt', 'addedBy', 'policyNumber'].forEach(key => {
          const td = document.createElement('td'); td.textContent = meta[key] || ''; tr.appendChild(td);
        });
        const viewTd = document.createElement('td');
        const url = typeof meta.url === 'string' ? meta.url : '';
        if (url) {
          const a = document.createElement('a');
          a.href = url; a.target = '_blank'; a.rel = 'noopener'; a.className = 'attc-icon'; a.innerHTML = PDF_ICON_SVG;
          viewTd.appendChild(a);
        }
        tr.appendChild(viewTd);
        tbody.appendChild(tr);
      });
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => {
          const s = String(fr.result || '');
          const i = s.indexOf(',');
          resolve(i >= 0 ? s.slice(i + 1) : s);
        };
        fr.onerror = () => reject(fr.error || new Error('File read failed'));
        fr.readAsDataURL(file);
      });
    }


    // Insert an optimistic "uploading..." row and return a handle we can replace
    function addOptimisticRow(kind, meta) {
      const isPolicy = (kind === 'policy');
      const table = document.getElementById(isPolicy ? 'policyTable' : 'accordTable');
      const tbody = table.querySelector('tbody');
      document.getElementById(isPolicy ? 'policyEmpty' : 'accordEmpty').style.display = 'none';

      const tr = document.createElement('tr');
      tr.dataset.optimistic = '1';
      const cells = [
        `${meta.name} (pending)`,
        meta.addedAt,
        meta.addedBy,
        meta.policyNumber,
        `<span class="attc-spin"></span>Uploading‚Ä¶`
      ];
      cells.forEach(html => {
        const td = document.createElement('td');
        td.innerHTML = html;
        tr.appendChild(td);
      });
      // Put new item on top for snappy feedback
      tbody.insertBefore(tr, tbody.firstChild || null);
      return tr;
    }

    function replaceOptimisticWithReal(kind, optimisticTr, items) {
      const isPolicy = (kind === 'policy');
      // Only re-render the target table (faster than drawing both)
      renderAttachmentTable(kind, JSON.stringify(items || []));
      if (optimisticTr && optimisticTr.parentNode) {
        optimisticTr.remove(); // already re-rendered list includes the real row
      }
    }

    // NEW: much faster handler with optimistic UI + chunked encoding
    // NEW: much faster handler with optimistic UI + chunked encoding
    async function handleAttachmentUpload(kind) {
      if (!custRowNum) { alert('Open a customer first'); return; }
      const input = document.getElementById(kind === 'policy' ? 'policyUpload' : 'accordUpload');
      const metaBox = document.getElementById(kind === 'policy' ? 'policyFileMeta' : 'accordFileMeta');
      const file = input.files && input.files[0];
      if (!file) return;
      if (file.type !== 'application/pdf') { alert('Please choose a PDF.'); input.value = ''; return; }

      // Show immediate feedback in the table
      const quickMeta = {
        name: file.name,
        addedAt: new Date().toLocaleString('en-US', { timeZone: 'America/New_York' }),
        addedBy: sessionUser || '',
        policyNumber: (custRowObj && custRowObj['Policy #']) || ''
      };
      const optimisticTr = addOptimisticRow(kind, quickMeta);
      metaBox.textContent = `Uploading ${file.name}‚Ä¶`;

      try {
        const b64 = await fileToBase64(file);

        // POST only once and only re-render the target table
        const text = await postToScript({
          action: 'uploadAttachment',
          password: sessionPassword,
          row: custRowNum,
          policyNumber: quickMeta.policyNumber,
          kind,
          fileName: file.name,
          fileB64: b64,
          addedBy: sessionUser
        });

        const resp = JSON.parse(text);
        if (!resp || !resp.ok) throw new Error(resp && resp.error ? resp.error : 'Upload failed');

        // Update our local cache so we don't need an extra fetch later
        if (!custRowObj) custRowObj = {};
        if (kind === 'policy') {
          custRowObj['Policy Forms'] = JSON.stringify(resp.policyForms || []);
          replaceOptimisticWithReal('policy', optimisticTr, resp.policyForms);
        } else {
          custRowObj['Accord Forms'] = JSON.stringify(resp.accordForms || []);
          replaceOptimisticWithReal('accord', optimisticTr, resp.accordForms);
        }

        metaBox.textContent = `Uploaded ${file.name}`;
      } catch (err) {
        console.error(err);
        metaBox.textContent = '';
        alert(err.message || 'Upload failed');
        // Clean up the optimistic row on error
        if (optimisticTr && optimisticTr.parentNode) optimisticTr.remove();
      } finally {
        input.value = '';
      }
    }

    // ‚¨áÔ∏è Helper to save the user-edited Accord PDF as a new form (keeps template visible)
    async function uploadEditedAccord() {
      if (!custRowNum) { alert('Open a customer first'); return; }
      const input = document.getElementById('accordEditedFile');
      const file = input.files && input.files[0];
      if (!file) { alert('Choose the edited PDF first.'); return; }
      if (file.type !== 'application/pdf') { alert('Please choose a PDF.'); return; }

      // Reuse the same uploader pathway as normal Accord uploads
      const dt = new DataTransfer();
      dt.items.add(file);
      const proxy = document.getElementById('accordUpload');
      proxy.files = dt.files;

      // Shows an optimistic row + persists via Apps Script
      await handleAttachmentUpload('accord');

      // keep viewer as-is (template remains editable)
    }



    /* ===== Notes Tab (latest 3 + pagination) ===== */
    // keep this near your notes state
    /* ===== Notes Tab (latest 3 + pagination) ===== */
    // keep this near your notes state
    let criticalBannerText = '';

    function parseNotesToArray(cell = '') {
      const all = String(cell).replace(/#\d+:\s*/g, '').split('\n').map(s => s.trim()).filter(Boolean);
      const crit = all.find(l => l.startsWith('[CRITICAL_ALERT]'));
      criticalBannerText = crit ? crit.replace('[CRITICAL_ALERT]', '').trim() : '';
      return all.filter(l => !l.startsWith('[CRITICAL_ALERT]'));
    }

    // ‚úÖ restore: updates the notes array and re-renders
    function rebuildNotes(cell = '') {
      notesArray = parseNotesToArray(cell);
      renderNotesPage();
    }

    function renderNotesPage() {
      const list = document.getElementById('notesList');
      list.innerHTML = '';

      if (criticalBannerText) {
        const badge = document.createElement('span');
        badge.className = 'note-entry critical';
        badge.textContent = criticalBannerText;
        list.appendChild(badge);
      }

      if (!notesArray.length) {
        const empty = document.createElement('div');
        empty.className = 'note-card';
        empty.textContent = 'No notes yet.';
        list.appendChild(empty);
        list.scrollTop = 0;
        return;
      }

      notesArray.forEach(raw => {
        const card = document.createElement('div');
        card.className = 'note-card';
        const m = raw.match(/^User:\s([^‚Äî]+)\s‚Äî\s([^‚Äî]+)\s‚Äî\s([\s\S]*)$/);
        if (m) {
          const meta = document.createElement('div');
          meta.className = 'note-meta';
          meta.textContent = `${m[1].trim()} ‚Ä¢ ${m[2].trim()}`;
          const text = document.createElement('div');
          text.className = 'note-text';
          text.textContent = m[3].trim();
          card.append(meta, text);
        } else {
          card.textContent = raw;
        }
        list.appendChild(card);
      });
      list.scrollTop = 0;
    }


    // --- Critical Alert helpers ---
    function ensureCriticalAtTop(notes) {
      const lines = String(notes || '').split('\n');
      const critical = lines.find(l => l.startsWith('[CRITICAL_ALERT]')) || '';
      const rest = lines.filter(l => !l.startsWith('[CRITICAL_ALERT]')).join('\n').trim();
      return (critical ? `${critical}\n` : '') + rest;
    }

    function promptCriticalAlertIfAny(rowObj) {
      const noteCell = (rowObj && (rowObj['Notes'] || rowObj['Note'] || rowObj['Notes Log'])) || '';
      const m = String(noteCell || '').match(/^\[CRITICAL_ALERT\]\s*(.+)$/m);
      if (!m) return;
      const message = m[1].trim();
      setTimeout(() => {
        const keep = confirm(`‚ö†Ô∏è CRITICAL ALERT\n\n${message}\n\nOK = Keep Alert\nCancel = Delete Alert`);
        if (!keep) {
          const cleaned = String(noteCell || '')
            .split('\n')
            .filter(line => !line.startsWith('[CRITICAL_ALERT]'))
            .join('\n')
            .trim();
          const finalNotes = cleaned; // removed alert

          // persist + refresh notes
          postToScript({
            action: 'edit', password: sessionPassword, row: custRowNum,
            policy: rowObj['Policy #'] || '', insurer: rowObj['Insurer'] || '',
            effDate: rowObj['Effective Date'] || rowObj['Effective'] || '',
            expDate: rowObj['Expiration Date'] || rowObj['Expiration'] || '',
            firstName: rowObj['First Name'] || rowObj['First'] || '',
            lastName: rowObj['Last Name'] || rowObj['Last'] || '',
            address: rowObj['Address'] || '', phone: rowObj['Phone'] || '',
            email: rowObj['Email'] || '', year: rowObj['Year'] || '',
            make: rowObj['Make'] || '', model: rowObj['Model'] || '',
            vin: rowObj['Vin #'] || '', notes: finalNotes
          }).then(() => {
            custRowObj['Notes'] = finalNotes;
            rebuildNotes(finalNotes);
            alert('Critical alert removed.');
          }).catch(err => alert('Failed to update alert: ' + err));
        }
      }, 0);
    }

    function addCriticalAlert() {
      const msg = prompt('Enter the CRITICAL ALERT message:');
      if (msg === null) return;
      const trimmed = String(msg || '').trim();
      if (!trimmed) { alert('Alert message cannot be empty.'); return; }

      const existing = (custRowObj && (custRowObj['Notes'] || custRowObj['Note'] || custRowObj['Notes Log'] || '')) || '';
      const cleaned = existing
        .split('\n')
        .filter(line => !line.startsWith('[CRITICAL_ALERT]'))
        .join('\n')
        .trim();
      const combined = ensureCriticalAtTop(`[CRITICAL_ALERT] ${trimmed}` + (cleaned ? `\n${cleaned}` : ''));

      // Update UI immediately
      custRowObj = custRowObj || {};
      custRowObj['Notes'] = combined;
      rebuildNotes(combined);

      // Persist
      if (!custRowNum) {
        alert('Critical Note Has Been Added. Click "Save" to persist it.');
        return;
      }

      postToScript({
        action: 'edit', password: sessionPassword, row: custRowNum,
        policy: custRowObj['Policy #'] || '', insurer: custRowObj['Insurer'] || '',
        effDate: custRowObj['Effective Date'] || custRowObj['Effective'] || '',
        expDate: custRowObj['Expiration Date'] || custRowObj['Expiration'] || '',
        firstName: custRowObj['First Name'] || custRowObj['First'] || '',
        lastName: custRowObj['Last Name'] || custRowObj['Last'] || '',
        address: custRowObj['Address'] || '', phone: custRowObj['Phone'] || '',
        email: custRowObj['Email'] || '', year: custRowObj['Year'] || '',
        make: custRowObj['Make'] || '', model: custRowObj['Model'] || '',
        vin: custRowObj['Vin #'] || '', notes: combined
      })
        .then(() => { alert('Critical Note Has Been Added'); })
        .catch(err => alert(err.message));
    }


    function addNoteFromTab() {
      const raw = (document.getElementById('noteInput').value || '').trim();
      if (!raw) { alert('Type a note first'); return; }

      const existingRaw = ((custRowObj && (custRowObj['Notes'] || custRowObj['Note'] || custRowObj['Notes Log'] || '')) || '');
      const lines = existingRaw.split('\n');
      const criticalLine = lines.find(l => l.startsWith('[CRITICAL_ALERT]')) || '';
      const withoutCritical = lines.filter(l => !l.startsWith('[CRITICAL_ALERT]')).join('\n').replace(/#\d+:\s*/g, '').trim();

      const ts = new Date().toLocaleString('en-US', {
        timeZone: 'America/New_York', month: 'short', day: 'numeric', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
      });
      const newUserLine = `User: ${sessionUser} ‚Äî ${ts} ‚Äî ${raw}`;
      const body = newUserLine + (withoutCritical ? `\n${withoutCritical}` : '');
      const combined = (criticalLine ? `${criticalLine}\n` : '') + body;

      custRowObj = custRowObj || {};
      custRowObj['Notes'] = combined;
      document.getElementById('noteInput').value = '';
      rebuildNotes(combined);

      // Persist only if editing an existing row; otherwise it will be saved when you click "Save"
      if (!custRowNum) return;

      postToScript({
        action: 'edit', password: sessionPassword, row: custRowNum,
        policy: custRowObj['Policy #'] || '', insurer: custRowObj['Insurer'] || '',
        effDate: custRowObj['Effective Date'] || custRowObj['Effective'] || '',
        expDate: custRowObj['Expiration Date'] || custRowObj['Expiration'] || '',
        firstName: custRowObj['First Name'] || custRowObj['First'] || '',
        lastName: custRowObj['Last Name'] || custRowObj['Last'] || '',
        address: custRowObj['Address'] || '', phone: custRowObj['Phone'] || '',
        email: custRowObj['Email'] || '', year: custRowObj['Year'] || '',
        make: custRowObj['Make'] || '', model: custRowObj['Model'] || '',
        vin: custRowObj['Vin #'] || '', notes: combined
      }).catch(err => alert(err.message));
    }



    // ---- Drop-zone wiring: click + drag&drop -> handleAttachmentUpload(kind)
    function initDropZone(kind) {
      const dz = document.getElementById(kind + 'Drop');
      const input = document.getElementById(kind + 'Upload');
      const meta = document.getElementById(kind + 'FileMeta');

      if (!dz || !input) return;

      // When user picks a file via the dialog
      input.addEventListener('change', () => {
        const f = input.files && input.files[0];
        meta.innerHTML = f ? `Selected: <span class="name">${f.name}</span>` : '';
        if (f) handleAttachmentUpload(kind);
      });

      // Drag & drop visuals
      ['dragenter', 'dragover'].forEach(ev => {
        dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dz.classList.add('dragover'); });
      });
      ['dragleave', 'drop'].forEach(ev => {
        dz.addEventListener(ev, e => { e.preventDefault(); e.stopPropagation(); dz.classList.remove('dragover'); });
      });

      // Handle a dropped file
      dz.addEventListener('drop', e => {
        const file = e.dataTransfer?.files?.[0];
        if (!file) return;
        if (file.type !== 'application/pdf') { alert('Please choose a PDF.'); return; }

        // Put dropped file into the hidden input so your existing uploader runs
        const dt = new DataTransfer();
        dt.items.add(file);
        input.files = dt.files;

        meta.innerHTML = `Selected: <span class="name">${file.name}</span>`;
        handleAttachmentUpload(kind);
      });
    }

    // Initialize both uploaders + row handlers when the page is ready
    document.addEventListener('DOMContentLoaded', () => {
      initDropZone('policy');
      initDropZone('accord');

      // Handle "Go" buttons and row selection on the main table
      document.addEventListener('click', (e) => {
        const go = e.target.closest('button.go-btn');
        if (go) {
          const rn = parseInt(go.dataset.row, 10);
          if (rn) { openCustomerPage('info', false, rn); }
          return;
        }
        const row = e.target.closest('#dataTable tbody tr');
        if (row) {
          selectedRowIndex = parseInt(row.dataset.row, 10);
          const tbody = document.querySelector('#dataTable tbody');
          if (tbody) { tbody.querySelectorAll('tr.selected').forEach(el => el.classList.remove('selected')); }
          row.classList.add('selected');
        }
      });

      // Mount Accord template viewer if a URL is provided
      const wrap = document.getElementById('accordViewerWrap');
      if (wrap && ACCORD_TEMPLATE_URL) {
        wrap.innerHTML = `<iframe src="${ACCORD_TEMPLATE_URL}#toolbar=1&navpanes=0"
        style="width:100%;height:100%;border:0;" title="Accord PDF"></iframe>`;
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      if (window.flatpickr) {
        // Policies tab
        flatpickr("#pe_effDate", { dateFormat: "Y-m-d", allowInput: true });
        flatpickr("#pe_expDate", { dateFormat: "Y-m-d", allowInput: true });

        // Add Client / Customer Info tab (same exact calendar)
        flatpickr("#ci_effDate", { dateFormat: "Y-m-d", allowInput: true });
        flatpickr("#ci_expDate", { dateFormat: "Y-m-d", allowInput: true });
      }
    });
  </script>

</body>

</html>