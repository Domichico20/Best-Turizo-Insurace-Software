<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=0.8, maximum-scale=0.8, user-scalable=yes">
  <title>Best Turizo Insurance Platform</title>

  <style>
    /* ===== Base / Theme ===== */
    :root {
      --bg: #f6f7f9;
      --card: #ffffff;
      --ink: #1f2937;
      --muted: #6b7280;
      --border: #e5e7eb;
      --brand1: #c59b6a;
      --brand2: #ab7d4a;
      --ok: #16a34a;
      --warn: #f59e0b;
      --danger: #ef4444;
      --radius: 14px;
      --shadow: 0 8px 24px rgba(16, 24, 40, .06);
    }

    html,
    body {
      background: var(--bg);
      color: var(--ink);
      font: 14px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif
    }

    header {
      text-align: center;
      margin: 14px 0 8px;
    }

    header img.logo {
      max-width: 540px;
      filter: drop-shadow(0 8px 18px rgba(0, 0, 0, .08));
    }

    /* ===== Login (UNCHANGED) ===== */
    #loginSection {
      width: 100%;
      max-width: 400px;
      padding: 28px;
      gap: 12px;
      margin: 0 auto;
      border-radius: 20px;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
    }

    #loginSection input {
      padding: 20px 100px;
      font-size: 16px;
      text-align: center;
      border: 1px solid var(--border);
      border-radius: 12px;
      outline: none;
      transition: border .15s;
    }

    #loginSection input::placeholder {
      text-align: center;
    }

    #loginSection input:focus {
      border-color: var(--brand1);
      box-shadow: 0 0 0 3px rgba(197, 155, 106, .18);
    }

    #loginSection button {
      width: 70%;
      margin: 0 auto;
      padding: 12px 14px;
      font-size: 20px;
      border-radius: 10px;
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      color: #fff;
      border: 0;
      cursor: pointer;
    }

    #customerPage .wrap {
      width: min(1400px, 96vw);
      margin: 0 auto;
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 18px;
      box-shadow: 0 10px 30px rgba(16, 24, 40, .08);
      padding: 22px 24px;
      box-sizing: border-box;
    }


    /* ===== Search Bar ===== */
    #searchSection {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin: 0 auto 6px;
      /* tighter gap */
      width: min(1100px, 92vw);
    }


    #searchSection input[type="text"] {
      flex: 0 1 760px;
      max-width: 760px;
      width: 100%;
      padding: 12px 14px;
      font-size: 1rem;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
    }

    #searchSection input[type="text"]:focus {
      border-color: var(--brand1);
      box-shadow: 0 0 0 3px rgba(197, 155, 106, .15);
    }

    #searchSection .search-btn {
      font-size: 1.6rem;
      padding: 20px 34px;
      border-radius: 14px;
      color: #fff;
      border: 0;
      cursor: pointer;
      background: linear-gradient(90deg,
          #9c4219 0%,
          #a54a1c 1.5%,
          #b05220 3%,
          #bb5a24 4.5%,
          #c56328 6%,
          #cf6b2c 7.5%,
          #d87331 9%,
          #e17c35 10.5%,
          #e9853a 12%,
          #f08e3f 13.5%,
          #f49747 15%,
          #f7a151 16.5%,
          #f9ab5c 18%,
          #fbb468 19.5%,
          #fcbf75 21%,
          #f8c985 22.5%,
          #f1d394 24%,
          #e6dc9f 26%,
          #d9e3a7 28%,
          #cae8ad 30%,
          #b9edb3 32%,
          #a6f0be 34%,
          #8ff3cb 36%,
          #76f4d9 38%,
          #5deee8 40%,
          #45e2f1 42%,
          #3bd2f7 44%,
          #3bbff7 46%,
          #49a9f5 48%,
          #5f90f4 50%,
          #736ff2 52%,
          #8055ef 54%,
          #8b3fee 56%,
          #9632ea 58%,
          #a12de2 60%,
          #ab31d6 62%,
          #b33ac7 64%,
          #b946b8 66%,
          #bd54a7 68%,
          #bf6396 70%,
          #bf7486 72%,
          #bc846f 74%,
          #b7935a 76%,
          #b1a148 78%,
          #a8ad3c 80%,
          #9fb736 82%,
          #95bf37 84%,
          #88c53e 86%,
          #7acc4c 88%,
          #6bd05f 90%,
          #62c563 91.5%,
          #5bb965 93%,
          #56ad65 94.5%,
          #529f63 96%,
          #5c8f5b 97%,
          #757d4e 98%,
          #9a673d 99%,
          #9c4219 100%);
      background-size: 800% 100%;
      animation: gradientShift 20s infinite linear;
      box-shadow: 0 6px 20px rgba(156, 66, 25, .4);

    }

    #searchSection .search-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(156, 66, 25, .6);
      animation-duration: 3s;
    }

    @keyframes gradientShift {
      0% {
        background-position: 0% 50%
      }

      100% {
        background-position: 200% 50%
      }
    }

    .button-row {
      display: none !important;
    }

    /* ===== Data Table ===== */
    #dataTable {
      width: 100%;
      margin: 0 auto;
      border-collapse: separate;
      border-spacing: 0;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(16, 24, 40, .06);
      table-layout: fixed;
    }

    #dataTable thead th {
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, #011d30, #6f93be);
      color: #f3f4f7;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-weight: 800;
      font-size: 1.45rem;
      padding: 12px 14px;
      text-align: center;
    }



    #dataTable thead th+th {
      box-shadow: inset 1px 0 0 #edf2f7;
    }

    #dataTable tbody td,
    #dataTable tbody th {
      padding: 12px 14px;
      border-top: 1px solid #eef2f7;
      vertical-align: middle;
      color: #0f172a;
      font-size: 20px;
      line-height: 1.35;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      text-align: center;
    }


    #dataTable tbody tr:nth-child(odd) {
      background: #fcfcff;
    }

    #dataTable tbody tr:hover {
      background: #f5f8ff;
    }

    #dataTable tr.selected {
      background: #e8f0ff !important;
      box-shadow: inset 0 0 0 2px rgba(59, 130, 246, .35);
    }

    /* Status pill + Go button */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 1.25rem;
    }

    .badge.active {
      background: #eaf7ef;
      color: #166534;
      border: 1px solid #a7f3d0;
    }

    .badge.inactive {
      background: #fdecec;
      color: #991b1b;
      border: 1px solid #fecaca;
    }

    .go-btn {
      padding: 8px 12px;
      border-radius: 10px;
      border: 1px solid #113f18;
      background: #66b684;
      color: #f5fcf8;
      cursor: pointer;
      font-weight: 800;
    }

    .go-btn:hover {
      background: #f3f4f6;
    }

    #customerPage .topbar {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      margin-bottom: 12px;
    }


    #customerPage .title {
      font-size: 2.15rem;
      font-weight: 900;
      letter-spacing: .3px;
      background: linear-gradient(90deg, #7c5b2e, #c79d4b 60%, #7c5b2e);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      text-shadow: 0 1px 0 rgba(0, 0, 0, .04);
    }


/* Tabs row */
.tabs{
  display:flex;
  gap:12px;
  margin:12px 0 16px;
  flex-wrap:wrap;
}

/* Modern pill tabs */

.tab{
  appearance:none;
  display:inline-flex;
  align-items:center;
  justify-content:center;
  gap:8px;

  padding:10px 16px;
  border-radius:999px;
  border:1px solid #e7d4bd;                 /* soft, premium border */
  background:linear-gradient(180deg,#ffffff,#faf6ef);
  color:#4a3b2a;                              /* rich brown to match brand */
  font-weight:700;
  line-height:1;

  box-shadow:0 1px 0 #ffffff inset, 0 8px 14px rgba(16,24,40,.06);
  transition:
    background .2s ease,
    transform .12s ease,
    box-shadow .2s ease,
    color .2s ease,
    border-color .2s ease;
}

/* Hover / Press / Focus */
.tab:hover{
  transform:translateY(-1px);
  background:linear-gradient(180deg,#ffffff,#f2eadf);
  box-shadow:0 12px 22px rgba(16,24,40,.12);
}

.tab:active{
  transform:none;
  box-shadow:0 4px 10px rgba(16,24,40,.10) inset;
}

.tab:focus-visible{
  outline:none;
  box-shadow:0 0 0 3px rgba(197,155,106,.35);
}

/* Selected tab (brand gradient) */
.tab[aria-selected="true"]{
  background:linear-gradient(180deg,#c59b6a,#ab7d4a);
  color:#ffffff;
  border-color:transparent;
  box-shadow:0 8px 18px rgba(171,125,74,.45);
}



    .tabpanel {
      display: none;
    }

    .tabpanel.active {
      display: block;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 18px;
    }


    @media(max-width:1100px) {
      .grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .card {
      background: linear-gradient(180deg, #ffffff, #faf8f5);
      border: 1px solid #eee1d2;
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow: 0 6px 18px rgba(16, 24, 40, .06);
    }

.label{
  font-family: Arial, Helvetica, sans-serif; /* consistent + legible */
  font-size: .95rem;                        /* modern, not oversized */
  line-height: 1.25;
  font-weight: 700;                         /* strong, professional */
  color: #4b5563;                           /* slate-600 */
  letter-spacing: .02em;                    /* tighter = cleaner */
  text-transform: none;                     /* sentence case reads better */
}


    .value {
      font-weight: 800;
      color: #3f3325;
      word-break: break-word;
      font-size: 1.05rem;
    }


    /* Forms */
    .form {
      display: grid;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      gap: 12px 14px;
    }

    .form .fg {
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    .form .fg label {
      font-size: 12px;
      color: var(--muted);
      margin: 0 0 4px;
      font-weight: 700;
    }

    .form .fg input,
    .form .fg textarea {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      background: #fff;
      box-shadow: 0 1px 0 rgba(16, 24, 40, .02) inset;
      transition: border-color .15s, box-shadow .15s;
    }

    .form .fg input:focus,
    .form .fg textarea:focus {
      border-color: var(--brand1);
      box-shadow: 0 0 0 3px rgba(197, 155, 106, .18);
      outline: none;
    }


    .row-full {
      grid-column: 1/-1;
    }

    .row-6 {
      grid-column: span 6;
    }

    .row-4 {
      grid-column: span 4;
    }

    .row-3 {
      grid-column: span 3;
    }

    .row-2 {
      grid-column: span 2;
    }

    .actionbar {
      display: flex;
      gap: 10px;
      margin: 10px 0;
    }

    .btn {
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #fff;
      cursor: pointer;
      font-weight: 800;
      box-shadow: 0 4px 12px rgba(16, 24, 40, .06);
      transition: transform .08s ease, box-shadow .12s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(16, 24, 40, .10);
    }

    .btn.primary {
      background: linear-gradient(90deg, var(--brand1), var(--brand2));
      color: #fff;
      border: 0;
    }

    .btn.safe {
      background: linear-gradient(90deg, #34d399, #10b981);
      color: #fff;
      border: 0;
    }

    .btn.warn {
      background: linear-gradient(90deg, #ef4444, #dc2626);
      color: #fff;
      border: 0;
    }


    /* Tables inside customer page */
    .themed-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(16, 24, 40, .06);
      table-layout: fixed;
    }

    .themed-table thead th {
      text-align: center;
    }

    .themed-table td,
    .themed-table th {
      text-align: center;
      font-size: 15px;
    }


    .themed-table thead th {
      position: sticky;
      top: 0;
      background: linear-gradient(180deg, #011d30, #6f93be);
      color: #f3f4f7;
      text-transform: uppercase;
      letter-spacing: .08em;
      font-weight: 800;
      font-size: 1rem;
      padding: 12px 14px;
    }

    .themed-table thead th+th {
      box-shadow: inset 1px 0 0 #edf2f7;
    }

    .themed-table td {
      padding: 9px 12px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-top: 1px solid #eef2f7;
    }

    /* Notes Tab */
    .notes-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-height: 420px;
      /* adjust height if you want */
      overflow-y: auto;
      /* <-- scrolling */
      padding-right: 8px;
    }

    .note-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 6px 14px rgba(16, 24, 40, .05);
    }

    .note-meta {
      font-size: .85rem;
      color: #6b7280;
      margin-bottom: 6px;
    }

    .note-text {
      white-space: pre-wrap;
      overflow-wrap: anywhere;
    }

    .pager {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 8px;
    }
  </style>
</head>

<body>
  <header>
    <img class="logo"
      src="https://raw.githubusercontent.com/Domichico20/Best-Turizo-Insurace-Software/11806dd4d5912b98aaba1ae08428968a18b2fa8a/logo.png"
      alt="Logo" />
  </header>

  <!-- ===== Login (unchanged) ===== -->
  <div id="loginSection">
    <input type="text" id="appUser" placeholder="Enter Username" />
    <input type="password" id="appPassword" placeholder="Enter Password"
      onkeydown="if(event.key==='Enter'){event.preventDefault();checkPassword();}">
    <button onclick="checkPassword()">Unlock</button>
  </div>

  <!-- ===== List Page ===== -->
  <div id="appSection" style="display:none;">
    <form id="searchForm" onsubmit="event.preventDefault(); searchData();">
      <div id="searchSection">
        <input type="text" id="searchQuery" placeholder="Search by Policy #, Insurance, Name, Phone, Email, Notes">
        <button type="submit" class="search-btn">Search</button>
      </div>
    </form>


    <table id="dataTable">
      <thead>
        <tr>
          <th>Policy #</th>
          <th>Insurer</th>
          <th>Effective</th>
          <th>Expiration</th>
          <th>Status</th>
          <th>First</th>
          <th>Last</th>
          <th>Address</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Go</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ===== Customer Overview Page ===== -->
  <div id="customerPage" style="display:none;">
    <div class="wrap">
      <div class="topbar">
        <div class="title">Customer Overview</div>
      </div>

      <div class="grid" id="custDetailsGrid"></div>

      <div class="tabs" role="tablist">
        <button class="tab" id="tabbtn-main" role="tab" aria-selected="false" onclick="goMainTab()">Main Page</button>
        <button class="tab" id="tabbtn-info" role="tab" aria-controls="tab-info" aria-selected="true"
          onclick="switchTab('info')">Customer Info</button>
        <button class="tab" id="tabbtn-policies" role="tab" aria-controls="tab-policies" aria-selected="false"
          onclick="switchTab('policies')">Policies</button>
        <button class="tab" id="tabbtn-files" role="tab" aria-controls="tab-files" aria-selected="false"
          onclick="switchTab('files')">Files</button>
        <button class="tab" id="tabbtn-accord" role="tab" aria-controls="tab-accord" aria-selected="false"
          onclick="switchTab('accord')">Accord</button>
        <button class="tab" id="tabbtn-notes" role="tab" aria-controls="tab-notes" aria-selected="false"
          onclick="switchTab('notes')">Notes</button>
      </div>

      <!-- Customer Info panel -->
      <section id="tab-info" class="tabpanel active" role="tabpanel" aria-labelledby="tabbtn-info">
        <div class="form" id="custInfoForm">
          <div class="fg row-3"><label>Policy #</label><input id="ci_policy"></div>
          <div class="fg row-3"><label>Insurer</label><input id="ci_insurer"></div>
          <div class="fg row-3"><label>Effective</label><input id="ci_effDate" type="date"></div>
          <div class="fg row-3"><label>Expiration</label><input id="ci_expDate" type="date"></div>

          <div class="fg row-3"><label>First Name</label><input id="ci_firstName"></div>
          <div class="fg row-3"><label>Last Name</label><input id="ci_lastName"></div>
          <div class="fg row-6"><label>Address</label><input id="ci_address"></div>

          <div class="fg row-3"><label>Phone</label><input id="ci_phone"></div>
          <div class="fg row-3"><label>Email</label><input id="ci_email" type="email"></div>

          <div class="fg row-3"><label>Year</label><input id="ci_year"></div>
          <div class="fg row-3"><label>Make</label><input id="ci_make"></div>
          <div class="fg row-3"><label>Model</label><input id="ci_model"></div>
          <div class="fg row-3"><label>Vin #</label><input id="ci_vin"></div>
        </div>
        <div class="actionbar">
          <button class="btn primary" onclick="saveCustomerInfo()">Save Changes</button>
        </div>
      </section>

      <!-- Policies panel -->
      <section id="tab-policies" class="tabpanel" role="tabpanel" aria-labelledby="tabbtn-policies">
        <div class="actionbar">
          <button class="btn safe" onclick="startAddPolicy()">Add Policy</button>
          <button class="btn" onclick="startEditPolicy()">Edit Policy</button>
        </div>
        <table class="themed-table" id="policiesTable">
          <thead>
            <tr>
              <th style="width:40px;">Sel</th>
              <th>Policy #</th>
              <th>Carrier</th>
              <th>Effective</th>
              <th>Expiration</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="attc-emptystate" id="policiesEmpty" style="display:none;">No policies found for this contact.</div>

        <!-- Inline editor -->
        <div id="policyEditor" style="display:none; margin-top:12px;">
          <div class="form">
            <div class="fg row-3"><label>Policy #</label><input id="pe_policy"></div>
            <div class="fg row-3"><label>Insurer</label><input id="pe_insurer"></div>
            <div class="fg row-3"><label>Effective</label><input id="pe_effDate" type="date"></div>
            <div class="fg row-3"><label>Expiration</label><input id="pe_expDate" type="date"></div>
            <div class="fg row-6"><label>Address</label><input id="pe_address"></div>
            <div class="fg row-3"><label>Phone</label><input id="pe_phone"></div>
            <div class="fg row-3"><label>Email</label><input id="pe_email" type="email"></div>
            <div class="fg row-3"><label>First Name</label><input id="pe_firstName"></div>
            <div class="fg row-3"><label>Last Name</label><input id="pe_lastName"></div>
            <div class="fg row-3"><label>Year</label><input id="pe_year"></div>
            <div class="fg row-3"><label>Make</label><input id="pe_make"></div>
            <div class="fg row-3"><label>Model</label><input id="pe_model"></div>
            <div class="fg row-3"><label>Vin #</label><input id="pe_vin"></div>
          </div>
          <div class="actionbar">
            <button class="btn primary" id="pe_save" onclick="savePolicyEditor()">Save Policy</button>
            <button class="btn" onclick="cancelPolicyEditor()">Cancel</button>
          </div>
        </div>
      </section>

      <!-- Files -->
      <section id="tab-files" class="tabpanel" role="tabpanel" aria-labelledby="tabbtn-files">
        <div class="attc-actions">
          <label for="policyUpload" class="attc-upload-btn">Upload PDF</label>
          <input id="policyUpload" class="hid-input" type="file" accept="application/pdf"
            onchange="handleAttachmentUpload('policy')">
        </div>
        <table class="themed-table" id="policyTable">
          <thead>
            <tr>
              <th>File Name</th>
              <th>Date Added</th>
              <th>Added By</th>
              <th>Policy #</th>
              <th>View</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="attc-emptystate" id="policyEmpty" style="display:none;">No policy forms uploaded yet.</div>
      </section>

      <!-- Accord -->
      <section id="tab-accord" class="tabpanel" role="tabpanel" aria-labelledby="tabbtn-accord">
        <div class="attc-actions">
          <label for="accordUpload" class="attc-upload-btn">Upload PDF</label>
          <input id="accordUpload" class="hid-input" type="file" accept="application/pdf"
            onchange="handleAttachmentUpload('accord')">
        </div>
        <table class="themed-table" id="accordTable">
          <thead>
            <tr>
              <th>File Name</th>
              <th>Date Added</th>
              <th>Added By</th>
              <th>Policy #</th>
              <th>View</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <div class="attc-emptystate" id="accordEmpty" style="display:none;">No accord forms uploaded yet.</div>
      </section>

      <!-- Notes -->
      <section id="tab-notes" class="tabpanel" role="tabpanel" aria-labelledby="tabbtn-notes">
        <div class="form">
          <div class="fg row-full">
            <label>Add a new note</label>
            <textarea id="noteInput" rows="3" placeholder="Type note and click Add Note"></textarea>
          </div>
        </div>
        <div class="actionbar">
          <button class="btn primary" onclick="addNoteFromTab()">Add Note</button>
        </div>
        <h3>Notes</h3>
        <div id="notesList" class="notes-list"></div>
        <!-- pager removed; notes list scrolls -->

      </section>
    </div>
  </div>

  <script>
    /* ===== Config / Constants ===== */
    const ROW_LIMIT = 25;
    const scriptURL = 'https://script.google.com/macros/s/AKfycbyxC9XhJ-ygxv9V2PqaB26_wvNSgsPBUiZQ4e4CLafx3IT2Kn6tpKyMN0e7oHMn9IvT/exec';
    const sheetId = '1q94KS8Dc2usWKc0h6iQvHP1sDfsPbgcybzXs4zpZANc';
    const apiKey = 'AIzaSyAhaKX_GIaCIXBsq43J3aMvqtGtFngdzrQ';
    const range = 'policies!A1:P';

    const USERS = { Edwin: 'Insurance2025', Islendy: 'Insurance2026', Penelope: 'Insurance2027' };

    const PDF_ICON_SVG = `
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" role="img" aria-label="PDF"><rect x="3" y="2" width="18" height="20" rx="2" fill="#e53935"/><polygon points="16,2 21,2 21,7" fill="#ffffff" opacity="0.9"/><text x="12" y="16" text-anchor="middle" font-family="Arial,Helvetica,sans-serif" font-size="8" font-weight="700" fill="#ffffff">PDF</text></svg>`;

    // session state
    let sessionPassword = "", sessionUser = "", selectedRowIndex = null; // sheet row number (1-based)
    let allDataRows = []; // [{r:[], sheetRow:n}]

    // Notes pagination state
    let notesArray = []; let notesPage = 1; const NOTES_PER_PAGE = 3;

    /* ===== Utilities ===== */
    function setZoomLevel() { document.body.style.zoom = '80%'; }
    document.addEventListener('DOMContentLoaded', setZoomLevel);

    async function postToScript(params) {
      const res = await fetch(scriptURL, { method: 'POST', body: new URLSearchParams(params) });
      const text = await res.text();
      if (!res.ok) throw new Error(`HTTP ${res.status}: ${text}`);
      return text;
    }

    window.checkPassword = function () {
      const userEl = document.getElementById('appUser');
      const passEl = document.getElementById('appPassword');
      const loginEl = document.getElementById('loginSection');
      const appEl = document.getElementById('appSection');

      const u = (userEl?.value || '').trim();
      const p = (passEl?.value || '').trim();

      if (USERS[u] === p) {
        sessionUser = u;
        sessionPassword = p;
        loginEl.style.display = 'none';
        appEl.style.display = 'block';
        loadData();
        setTimeout(setZoomLevel, 100);
        return true;
      }
      alert('Incorrect username or password');
      return false;
    };

    // Dates / status helpers
    function parseExpDate(v) { if (!v) return null; const d = new Date(String(v).trim()); return isNaN(d.getTime()) ? null : d; }
    function compareByExpiration(a, b) { const da = parseExpDate(a.r[3]); const db = parseExpDate(b.r[3]); if (da && db) return da - db; if (da && !db) return -1; if (!da && db) return 1; return 0; }
    function computeStatus(exp) { const d = parseExpDate(exp); if (!d) return 'Inactive'; const today = new Date(); today.setHours(0, 0, 0, 0); return (d >= today) ? 'Active' : 'Inactive'; }
    function statusBadge(status) { const cls = status === 'Active' ? 'active' : 'inactive'; return `<span class="badge ${cls}">${status}</span>`; }

    function clearSelection() {
      document.querySelectorAll('#dataTable tr.selected').forEach(r => r.classList.remove('selected'));
      selectedRowIndex = null;
    }

    /* ===== List page: load & render ===== */
    function renderRow(tbody, obj) {
      const row = obj.r;
      const tr = tbody.insertRow();

      const status = computeStatus(row[3]);
      const cells = [
        row[0] || '', row[1] || '', row[2] || '', row[3] || '', statusBadge(status),
        row[4] || '', row[5] || '', row[6] || '', row[7] || '', row[8] || ''
      ];
      cells.forEach((val, i) => {
        const td = tr.insertCell();
        td.innerHTML = (i === 4 ? val : (val || ''));
      });

      // Go button opens overview for THIS row (no selection needed)
      const goTd = tr.insertCell();
      const goBtn = document.createElement('button');
      goBtn.className = 'go-btn';
      goBtn.textContent = 'Go';
      goBtn.addEventListener('click', (ev) => {
        ev.stopPropagation();
        openCustomerPage('info', false, obj.sheetRow);
      });
      goTd.appendChild(goBtn);

      // row selection (for Delete/Edit/etc.)
      tr.onclick = (e) => {
        if (e.target.closest('.go-btn')) return;
        selectedRowIndex = obj.sheetRow;
        document.querySelectorAll('#dataTable tr.selected').forEach(r => r.classList.remove('selected'));
        tr.classList.add('selected');
      };
    }

    function loadData() {
      fetch(`https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`)
        .then(res => res.json())
        .then(data => {
          const rows = data.values || [];
          const body = rows.slice(1).map((r, idx) => ({ r, sheetRow: idx + 2 }));
          body.sort(compareByExpiration);
          allDataRows = body;

          const tbody = document.querySelector('#dataTable tbody');
          tbody.innerHTML = '';
          document.getElementById('searchQuery').value = '';

          body.slice(0, ROW_LIMIT).forEach(o => renderRow(tbody, o));
        })
        .catch(err => {
          console.error(err);
          alert('Could not load data. Check API key, sheetId, and sharing.');
        });
    }

    function searchData() {
      const q = document.getElementById('searchQuery').value.toLowerCase().trim();
      const tbody = document.querySelector('#dataTable tbody');
      tbody.innerHTML = '';
      if (!q) { loadData(); return; }
      const filtered = allDataRows.filter(o => (o.r.join(' ') || '').toLowerCase().includes(q));
      filtered.sort(compareByExpiration);
      filtered.forEach(o => renderRow(tbody, o));
    }

    function confirmDelete() {
      if (selectedRowIndex === null) { alert('Select a row first.'); return; }
      if (!confirm('Delete selected row?')) return;
      postToScript({ action: 'delete', password: sessionPassword, row: selectedRowIndex })
        .then(msg => { alert(msg); selectedRowIndex = null; loadData(); })
        .catch(err => alert(err.message));
    }

    /* ===== Customer Overview: state ===== */
    let custRowNum = null, custRowObj = null; // current row in overview
    let peMode = 'add', peEditRow = null;     // policies editor state

    function openCustomerPage(openTab = 'info', addMode = false, explicitRow = null) {
      const rowNum = explicitRow ?? selectedRowIndex;
      if (!rowNum) { alert('Select a row first.'); return; }
      custRowNum = rowNum;

      postToScript({ action: 'getRow', password: sessionPassword, row: rowNum })
        .then(txt => {
          const payload = JSON.parse(txt);
          if (!payload.ok) throw new Error(payload.error || 'Unknown error');
          custRowObj = payload.row;

          renderCustomerHeader(custRowObj);
          fillCustomerInfo(custRowObj);

          // files / accord
          renderAttachmentTable('policy', custRowObj['Policy Forms']);
          renderAttachmentTable('accord', custRowObj['Accord Forms']);

          // policies for this contact
          renderPoliciesOfContact();

          // notes (latest 3 + pager)
          rebuildNotes(custRowObj['Notes'] || '');

          showPage('customer');
          switchTab(addMode ? 'policies' : openTab);
          if (addMode) startAddPolicy(true);
        })
        .catch(err => alert(err.message));
    }

    function closeCustomerPage() { showPage('app'); setTimeout(setZoomLevel, 50); }
    function goMainTab() { closeCustomerPage(); }   // used by the "Main Page" tab

    function showPage(which) {
      document.getElementById('appSection').style.display = (which === 'app') ? 'block' : 'none';
      document.getElementById('customerPage').style.display = (which === 'customer') ? 'block' : 'none';
    }
    function switchTab(name) {
      ['info', 'policies', 'files', 'accord', 'notes'].forEach(n => {
        const el = document.getElementById(`tab-${n}`);
        const btn = document.getElementById(`tabbtn-${n}`);
        if (el) el.classList.toggle('active', n === name);
        if (btn) btn.setAttribute('aria-selected', n === name ? 'true' : 'false');
      });
    }
    function goMainTab() { closeCustomerPage(); }


    // header summary grid
    function renderCustomerHeader(row) {
      const grid = document.getElementById('custDetailsGrid');
      const map = (k) => String(row[k] || '');
      const fields = [
        ['Policy #', 'Policy #'], ['Insurer', 'Insurer'], ['Effective', 'Effective'], ['Expiration', 'Expiration'],
        ['First', 'First'], ['Last', 'Last'], ['Address', 'Address'], ['Phone', 'Phone'], ['Email', 'Email']
      ];
      grid.innerHTML = '';
      fields.forEach(([label, key]) => {
        const card = document.createElement('div'); card.className = 'card';
        const lab = document.createElement('div'); lab.className = 'label'; lab.textContent = label;
        const val = document.createElement('div'); val.className = 'value'; val.textContent = map(key);
        card.append(lab, val); grid.append(card);
      });
    }

    /* ===== Customer Info ===== */
    function fillCustomerInfo(row) {
      const g = id => document.getElementById(id);
      g('ci_policy').value = row['Policy #'] || '';
      g('ci_insurer').value = row['Insurer'] || '';
      g('ci_effDate').value = (row['Effective'] || '').split('T')[0];
      g('ci_expDate').value = (row['Expiration'] || '').split('T')[0];
      g('ci_firstName').value = row['First'] || '';
      g('ci_lastName').value = row['Last'] || '';
      g('ci_address').value = row['Address'] || '';
      g('ci_phone').value = row['Phone'] || '';
      g('ci_email').value = row['Email'] || '';
      g('ci_year').value = row['Year'] || '';
      g('ci_make').value = row['Make'] || '';
      g('ci_model').value = row['Model'] || '';
      g('ci_vin').value = row['Vin #'] || '';
    }

    function saveCustomerInfo() {
      if (!custRowNum) { alert('No row selected'); return; }
      const g = id => document.getElementById(id).value.trim();
      postToScript({
        action: 'edit', password: sessionPassword, row: custRowNum,
        policy: g('ci_policy'), insurer: g('ci_insurer'),
        effDate: g('ci_effDate'), expDate: g('ci_expDate'),
        firstName: g('ci_firstName'), lastName: g('ci_lastName'),
        address: g('ci_address'), phone: g('ci_phone'), email: g('ci_email'),
        year: g('ci_year'), make: g('ci_make'), model: g('ci_model'), vin: g('ci_vin'),
        notes: custRowObj ? (custRowObj['Notes'] || '') : ''
      }).then(() => {
        alert('Saved');
        loadData();
        openCustomerPage('info', false, custRowNum);
      }).catch(err => alert(err.message));
    }

    /* ===== Policies for the same contact ===== */
    function renderPoliciesOfContact() {
      const tbody = document.querySelector('#policiesTable tbody');
      const empty = document.getElementById('policiesEmpty');
      tbody.innerHTML = '';

      if (!custRowObj) { empty.style.display = 'block'; return; }

      const first = (custRowObj['First'] || '').toLowerCase();
      const last = (custRowObj['Last'] || '').toLowerCase();
      const phone = (custRowObj['Phone'] || '').replace(/\D/g, '');

      const matches = allDataRows.filter(o => {
        const r = o.r;
        const f = (r[4] || '').toLowerCase();
        const l = (r[5] || '').toLowerCase();
        const p = (r[7] || '').replace(/\D/g, '');
        return (f === first && l === last) || (p && phone && p === phone);
      });

      if (!matches.length) { empty.style.display = 'block'; return; }
      empty.style.display = 'none';

      matches.forEach(o => {
        const tr = document.createElement('tr');
        const selTd = document.createElement('td');
        selTd.innerHTML = `<input type="radio" name="polsel" value="${o.sheetRow}">`;
        tr.appendChild(selTd);

        const st = computeStatus(o.r[3]);
        [o.r[0] || '', o.r[1] || '', o.r[2] || '', o.r[3] || '', statusBadge(st)].forEach(v => {
          const td = document.createElement('td'); td.innerHTML = v; tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    function startAddPolicy(fromTop = false) {
      peMode = 'add'; peEditRow = null;
      document.getElementById('policyEditor').style.display = 'block';
      const r = custRowObj || {}; const g = id => document.getElementById(id);
      g('pe_policy').value = ''; g('pe_insurer').value = r['Insurer'] || '';
      g('pe_effDate').value = ''; g('pe_expDate').value = '';
      g('pe_address').value = r['Address'] || '';
      g('pe_phone').value = r['Phone'] || ''; g('pe_email').value = r['Email'] || '';
      g('pe_firstName').value = r['First'] || ''; g('pe_lastName').value = r['Last'] || '';
      g('pe_year').value = r['Year'] || ''; g('pe_make').value = r['Make'] || '';
      g('pe_model').value = r['Model'] || ''; g('pe_vin').value = r['Vin #'] || '';
      if (!fromTop) switchTab('policies');
    }

    function startEditPolicy() {
      const sel = document.querySelector('input[name="polsel"]:checked');
      if (!sel) { alert('Select a policy in the list'); return; }
      peMode = 'edit'; peEditRow = parseInt(sel.value, 10);
      document.getElementById('policyEditor').style.display = 'block';
      postToScript({ action: 'getRow', password: sessionPassword, row: peEditRow })
        .then(txt => {
          const p = JSON.parse(txt); if (!p.ok) throw new Error('Row not found');
          const r = p.row; const g = id => document.getElementById(id);
          g('pe_policy').value = r['Policy #'] || ''; g('pe_insurer').value = r['Insurer'] || '';
          g('pe_effDate').value = (r['Effective'] || '').split('T')[0];
          g('pe_expDate').value = (r['Expiration'] || '').split('T')[0];
          g('pe_address').value = r['Address'] || ''; g('pe_phone').value = r['Phone'] || '';
          g('pe_email').value = r['Email'] || ''; g('pe_firstName').value = r['First'] || '';
          g('pe_lastName').value = r['Last'] || ''; g('pe_year').value = r['Year'] || '';
          g('pe_make').value = r['Make'] || ''; g('pe_model').value = r['Model'] || '';
          g('pe_vin').value = r['Vin #'] || '';
        })
        .catch(err => alert(err.message));
    }

    function cancelPolicyEditor() { document.getElementById('policyEditor').style.display = 'none'; }

    function savePolicyEditor() {
      const g = id => document.getElementById(id).value.trim();
      if (peMode === 'add') {
        if (!g('pe_policy')) { alert('Policy # is required'); return; }
        postToScript({
          action: 'add', password: sessionPassword,
          policy: g('pe_policy'), insurer: g('pe_insurer'),
          effDate: g('pe_effDate'), expDate: g('pe_expDate'),
          firstName: g('pe_firstName'), lastName: g('pe_lastName'),
          address: g('pe_address'), phone: g('pe_phone'), email: g('pe_email'),
          year: g('pe_year'), make: g('pe_make'), model: g('pe_model'), vin: g('pe_vin'),
          notes: ''
        }).then(() => {
          alert('Policy added');
          document.getElementById('policyEditor').style.display = 'none';
          loadData(); renderPoliciesOfContact();
        }).catch(err => alert(err.message));
      } else {
        postToScript({
          action: 'edit', password: sessionPassword, row: peEditRow,
          policy: g('pe_policy'), insurer: g('pe_insurer'),
          effDate: g('pe_effDate'), expDate: g('pe_expDate'),
          firstName: g('pe_firstName'), lastName: g('pe_lastName'),
          address: g('pe_address'), phone: g('pe_phone'), email: g('pe_email'),
          year: g('pe_year'), make: g('pe_make'), model: g('pe_model'), vin: g('pe_vin'),
          notes: ''
        }).then(() => {
          alert('Policy updated');
          document.getElementById('policyEditor').style.display = 'none';
          loadData(); renderPoliciesOfContact();
        }).catch(err => alert(err.message));
      }
    }

    /* ===== Files / Accord ===== */
    function renderAttachmentTable(kind, jsonCell) {
      const isPolicy = (kind === 'policy');
      const tbody = document.getElementById(isPolicy ? 'policyTable' : 'accordTable').querySelector('tbody');
      const empty = document.getElementById(isPolicy ? 'policyEmpty' : 'accordEmpty');
      let items = []; try { items = jsonCell ? JSON.parse(jsonCell) : []; } catch (e) { items = []; }
      tbody.innerHTML = ''; if (!items.length) { empty.style.display = 'block'; return; }
      empty.style.display = 'none';
      items.forEach(meta => {
        const tr = document.createElement('tr');
        ['name', 'addedAt', 'addedBy', 'policyNumber'].forEach(key => {
          const td = document.createElement('td'); td.textContent = meta[key] || ''; tr.appendChild(td);
        });
        const viewTd = document.createElement('td');
        const url = typeof meta.url === 'string' ? meta.url : '';
        if (url) {
          const a = document.createElement('a');
          a.href = url; a.target = '_blank'; a.rel = 'noopener'; a.className = 'attc-icon'; a.innerHTML = PDF_ICON_SVG;
          viewTd.appendChild(a);
        }
        tr.appendChild(viewTd);
        tbody.appendChild(tr);
      });
    }

    function handleAttachmentUpload(kind) {
      if (!custRowNum) { alert('Open a customer first'); return; }
      const input = document.getElementById(kind === 'policy' ? 'policyUpload' : 'accordUpload');
      const file = input.files && input.files[0]; if (!file) { return; }
      if (file.type !== 'application/pdf') { alert('Please choose a PDF.'); input.value = ''; return; }

      const reader = new FileReader();
      reader.onloadend = () => {
        const b64 = reader.result.split(',')[1];
        postToScript({
          action: 'uploadAttachment', password: sessionPassword, row: custRowNum,
          policyNumber: (custRowObj && custRowObj['Policy #']) || '',
          kind, fileName: file.name, fileB64: b64, addedBy: sessionUser
        }).then(text => {
          const p = JSON.parse(text);
          if (!p || !p.ok) throw new Error(p && p.error ? p.error : 'Upload failed');
          renderAttachmentTable('policy', JSON.stringify(p.policyForms || []));
          renderAttachmentTable('accord', JSON.stringify(p.accordForms || []));
          input.value = ''; alert('Uploaded!');
        }).catch(err => alert(err.message));
      };
      reader.readAsDataURL(file);
    }

    /* ===== Notes Tab (latest 3 + pagination) ===== */
    function parseNotesToArray(cell = '') {
      const stripped = String(cell).replace(/#\d+:\s*/g, '').trim();
      if (!stripped) return [];
      return stripped.split(/(?=User:\s)/g).map(s => s.trim()).filter(Boolean);
    }
    function rebuildNotes(cell) { notesArray = parseNotesToArray(cell); notesPage = 1; renderNotesPage(); }

    function renderNotesPage() {
      const list = document.getElementById('notesList');
      list.innerHTML = '';
      if (!notesArray.length) {
        list.innerHTML = '<div class="note-card">No notes yet.</div>';
        return;
      }
      // newest first (your notes are stored newest-first already)
      notesArray.forEach(raw => {
        const card = document.createElement('div');
        card.className = 'note-card';
        const m = raw.match(/^User:\s([^—]+)\s—\s([^—]+)\s—\s([\s\S]*)$/);
        if (m) {
          const meta = document.createElement('div');
          meta.className = 'note-meta';
          meta.textContent = `${m[1].trim()} • ${m[2].trim()}`;
          const text = document.createElement('div');
          text.className = 'note-text';
          text.textContent = m[3].trim();
          card.append(meta, text);
        } else {
          card.textContent = raw;
        }
        list.appendChild(card);
      });
      // ensure we’re at the top each time we rebuild
      list.scrollTop = 0;
    }


    label.textContent = `${notesPage} / ${totalPages}`;

    function prevNotesPage() { }  // no-op (pager removed)
    function nextNotesPage() { }  // no-op (pager removed)

    function addNoteFromTab() {
      if (!custRowNum) { alert('Open a customer first'); return; }
      const raw = (document.getElementById('noteInput').value || '').trim();
      if (!raw) { alert('Type a note first'); return; }

      postToScript({ action: 'getRow', password: sessionPassword, row: custRowNum })
        .then(txt => {
          const p = JSON.parse(txt); if (!p.ok) throw new Error('Row not found');
          const existing = (p.row['Notes'] || '').replace(/#\d+:\s*/g, '').trim();
          const ts = new Date().toLocaleString('en-US', { timeZone: 'America/New_York', month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' });
          const combined = `User: ${sessionUser} — ${ts} — ${raw}` + (existing ? `\n${existing}` : '');
          return postToScript({
            action: 'edit', password: sessionPassword, row: custRowNum,
            policy: p.row['Policy #'] || '', insurer: p.row['Insurer'] || '',
            effDate: p.row['Effective'] || '', expDate: p.row['Expiration'] || '',
            firstName: p.row['First'] || '', lastName: p.row['Last'] || '',
            address: p.row['Address'] || '', phone: p.row['Phone'] || '',
            email: p.row['Email'] || '', year: p.row['Year'] || '',
            make: p.row['Make'] || '', model: p.row['Model'] || '',
            vin: p.row['Vin #'] || '', notes: combined
          });
        })
        .then(() => {
          document.getElementById('noteInput').value = '';
          return postToScript({ action: 'getRow', password: sessionPassword, row: custRowNum });
        })
        .then(txt => {
          const p = JSON.parse(txt); custRowObj = p.row; rebuildNotes(custRowObj['Notes'] || ''); alert('Note added');
        })
        .catch(err => alert(err.message));
    }
  </script>
</body>

</html>